{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"TelemetryPlugin\", {\n  enumerable: true,\n  get: function () {\n    return TelemetryPlugin;\n  }\n});\nconst _webpack = require(\"next/dist/compiled/webpack/webpack\");\n// Map of a feature module to the file it belongs in the next package.\nconst FEATURE_MODULE_MAP = new Map([[\"next/image\", \"/next/image.js\"], [\"next/future/image\", \"/next/future/image.js\"], [\"next/legacy/image\", \"/next/legacy/image.js\"], [\"next/script\", \"/next/script.js\"], [\"next/dynamic\", \"/next/dynamic.js\"]]);\nconst FEATURE_MODULE_REGEXP_MAP = new Map([[\"@next/font/google\", /\\/@next\\/font\\/google\\/target.css?.+$/], [\"@next/font/local\", /\\/@next\\/font\\/local\\/target.css?.+$/], [\"next/font/google\", /\\/next\\/font\\/google\\/target.css?.+$/], [\"next/font/local\", /\\/next\\/font\\/local\\/target.css?.+$/]]);\n// List of build features used in webpack configuration\nconst BUILD_FEATURES = [\"swcLoader\", \"swcMinify\", \"swcRelay\", \"swcStyledComponents\", \"swcReactRemoveProperties\", \"swcExperimentalDecorators\", \"swcRemoveConsole\", \"swcImportSource\", \"swcEmotion\", \"swc/target/x86_64-apple-darwin\", \"swc/target/x86_64-unknown-linux-gnu\", \"swc/target/x86_64-pc-windows-msvc\", \"swc/target/i686-pc-windows-msvc\", \"swc/target/aarch64-unknown-linux-gnu\", \"swc/target/armv7-unknown-linux-gnueabihf\", \"swc/target/aarch64-apple-darwin\", \"swc/target/aarch64-linux-android\", \"swc/target/arm-linux-androideabi\", \"swc/target/x86_64-unknown-freebsd\", \"swc/target/x86_64-unknown-linux-musl\", \"swc/target/aarch64-unknown-linux-musl\", \"swc/target/aarch64-pc-windows-msvc\", \"turbotrace\", \"transpilePackages\", \"skipMiddlewareUrlNormalize\", \"skipTrailingSlashRedirect\", \"modularizeImports\"];\nconst ELIMINATED_PACKAGES = new Set();\n/**\n * Determine if there is a feature of interest in the specified 'module'.\n */\nfunction findFeatureInModule(module) {\n  if (module.type !== \"javascript/auto\") {\n    return;\n  }\n  const normalizedIdentifier = module.identifier().replace(/\\\\/g, \"/\");\n  for (const [feature, path] of FEATURE_MODULE_MAP) {\n    if (normalizedIdentifier.endsWith(path)) {\n      return feature;\n    }\n  }\n  for (const [feature, regexp] of FEATURE_MODULE_REGEXP_MAP) {\n    if (regexp.test(normalizedIdentifier)) {\n      return feature;\n    }\n  }\n}\n/**\n * Find unique origin modules in the specified 'connections', which possibly\n * contains more than one connection for a module due to different types of\n * dependency.\n */\nfunction findUniqueOriginModulesInConnections(connections, originModule) {\n  const originModules = new Set();\n  for (const connection of connections) {\n    if (!originModules.has(connection.originModule) && connection.originModule !== originModule) {\n      originModules.add(connection.originModule);\n    }\n  }\n  return originModules;\n}\nclass TelemetryPlugin {\n  // Build feature usage is on/off and is known before the build starts\n  constructor(buildFeaturesMap) {\n    this.usageTracker = new Map();\n    for (const featureName of BUILD_FEATURES) {\n      this.usageTracker.set(featureName, {\n        featureName,\n        invocationCount: buildFeaturesMap.get(featureName) ? 1 : 0\n      });\n    }\n    for (const featureName of FEATURE_MODULE_MAP.keys()) {\n      this.usageTracker.set(featureName, {\n        featureName,\n        invocationCount: 0\n      });\n    }\n    for (const featureName of FEATURE_MODULE_REGEXP_MAP.keys()) {\n      this.usageTracker.set(featureName, {\n        featureName,\n        invocationCount: 0\n      });\n    }\n  }\n  apply(compiler) {\n    compiler.hooks.make.tapAsync(TelemetryPlugin.name, async (compilation, callback) => {\n      compilation.hooks.finishModules.tapAsync(TelemetryPlugin.name, async (modules, modulesFinish) => {\n        for (const module of modules) {\n          const feature = findFeatureInModule(module);\n          if (!feature) {\n            continue;\n          }\n          const connections = compilation.moduleGraph.getIncomingConnections(module);\n          const originModules = findUniqueOriginModulesInConnections(connections, module);\n          this.usageTracker.get(feature).invocationCount = originModules.size;\n        }\n        modulesFinish();\n      });\n      callback();\n    });\n    if (compiler.options.mode === \"production\" && !compiler.watchMode) {\n      compiler.hooks.compilation.tap(TelemetryPlugin.name, compilation => {\n        const moduleHooks = _webpack.NormalModule.getCompilationHooks(compilation);\n        moduleHooks.loader.tap(TelemetryPlugin.name, loaderContext => {\n          loaderContext.eliminatedPackages = ELIMINATED_PACKAGES;\n        });\n      });\n    }\n  }\n  usages() {\n    return [...this.usageTracker.values()];\n  }\n  packagesUsedInServerSideProps() {\n    return Array.from(ELIMINATED_PACKAGES);\n  }\n}","map":{"version":3,"names":["TelemetryPlugin","FEATURE_MODULE_MAP","Map","FEATURE_MODULE_REGEXP_MAP","BUILD_FEATURES","ELIMINATED_PACKAGES","Set","findFeatureInModule","module","type","normalizedIdentifier","identifier","replace","feature","path","endsWith","regexp","test","findUniqueOriginModulesInConnections","connections","originModule","originModules","connection","has","add","constructor","buildFeaturesMap","usageTracker","featureName","set","invocationCount","get","keys","apply","compiler","hooks","make","tapAsync","name","compilation","callback","finishModules","modules","modulesFinish","moduleGraph","getIncomingConnections","size","options","mode","watchMode","tap","moduleHooks","_webpack","NormalModule","getCompilationHooks","loader","loaderContext","eliminatedPackages","usages","values","packagesUsedInServerSideProps","Array","from"],"sources":["../../../../src/build/webpack/plugins/telemetry-plugin.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}
{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n0 && (module.exports = {\n  ErrorSource: null,\n  getRuntimeContext: null,\n  run: null\n});\nfunction _export(target, all) {\n  for (var name in all) Object.defineProperty(target, name, {\n    enumerable: true,\n    get: all[name]\n  });\n}\n_export(exports, {\n  ErrorSource: function () {\n    return ErrorSource;\n  },\n  getRuntimeContext: function () {\n    return getRuntimeContext;\n  },\n  run: function () {\n    return run;\n  }\n});\nconst _middleware = require(\"next/dist/compiled/@next/react-dev-overlay/dist/middleware\");\nconst _context = require(\"./context\");\nconst _bodystreams = require(\"../../body-streams\");\nconst _approuterheaders = require(\"../../../client/components/app-router-headers\");\nconst ErrorSource = Symbol(\"SandboxError\");\nconst FORBIDDEN_HEADERS = [\"content-length\", \"content-encoding\", \"transfer-encoding\"];\n/**\n * Decorates the runner function making sure all errors it can produce are\n * tagged with `edge-server` so they can properly be rendered in dev.\n */\nfunction withTaggedErrors(fn) {\n  return params => fn(params).then(result => {\n    var _result_waitUntil;\n    return {\n      ...result,\n      waitUntil: result == null ? void 0 : (_result_waitUntil = result.waitUntil) == null ? void 0 : _result_waitUntil.catch(error => {\n        // TODO: used COMPILER_NAMES.edgeServer instead. Verify that it does not increase the runtime size.\n        throw (0, _middleware.getServerError)(error, \"edge-server\");\n      })\n    };\n  }).catch(error => {\n    // TODO: used COMPILER_NAMES.edgeServer instead\n    throw (0, _middleware.getServerError)(error, \"edge-server\");\n  });\n}\nasync function getRuntimeContext(params) {\n  const {\n    runtime,\n    evaluateInContext\n  } = await (0, _context.getModuleContext)({\n    moduleName: params.name,\n    onWarning: params.onWarning ?? (() => {}),\n    useCache: params.useCache !== false,\n    edgeFunctionEntry: params.edgeFunctionEntry,\n    distDir: params.distDir\n  });\n  if (params.incrementalCache) {\n    runtime.context.globalThis.__incrementalCache = params.incrementalCache;\n  }\n  for (const paramPath of params.paths) {\n    evaluateInContext(paramPath);\n  }\n  return runtime;\n}\nconst run = withTaggedErrors(async function runWithTaggedErrors(params) {\n  var _params_request_body;\n  const runtime = await getRuntimeContext(params);\n  const subreq = params.request.headers[`x-middleware-subrequest`];\n  const subrequests = typeof subreq === \"string\" ? subreq.split(\":\") : [];\n  if (subrequests.includes(params.name)) {\n    return {\n      waitUntil: Promise.resolve(),\n      response: new runtime.context.Response(null, {\n        headers: {\n          \"x-middleware-next\": \"1\"\n        }\n      })\n    };\n  }\n  const edgeFunction = runtime.context._ENTRIES[`middleware_${params.name}`].default;\n  const cloned = ![\"HEAD\", \"GET\"].includes(params.request.method) ? (_params_request_body = params.request.body) == null ? void 0 : _params_request_body.cloneBodyStream() : undefined;\n  const KUint8Array = runtime.evaluate(\"Uint8Array\");\n  const urlInstance = new URL(params.request.url);\n  urlInstance.searchParams.delete(_approuterheaders.NEXT_RSC_UNION_QUERY);\n  params.request.url = urlInstance.toString();\n  try {\n    const result = await edgeFunction({\n      request: {\n        ...params.request,\n        body: cloned && (0, _bodystreams.requestToBodyStream)(runtime.context, KUint8Array, cloned)\n      }\n    });\n    for (const headerName of FORBIDDEN_HEADERS) {\n      result.response.headers.delete(headerName);\n    }\n    return result;\n  } finally {\n    var _params_request_body1;\n    await ((_params_request_body1 = params.request.body) == null ? void 0 : _params_request_body1.finalize());\n  }\n});","map":{"version":3,"names":["ErrorSource","getRuntimeContext","run","Symbol","FORBIDDEN_HEADERS","withTaggedErrors","fn","params","then","result","_result_waitUntil","waitUntil","catch","error","_middleware","getServerError","runtime","evaluateInContext","_context","getModuleContext","moduleName","name","onWarning","useCache","edgeFunctionEntry","distDir","incrementalCache","context","globalThis","__incrementalCache","paramPath","paths","runWithTaggedErrors","_params_request_body","subreq","request","headers","subrequests","split","includes","Promise","resolve","response","Response","edgeFunction","_ENTRIES","default","cloned","method","body","cloneBodyStream","undefined","KUint8Array","evaluate","urlInstance","URL","url","searchParams","delete","_approuterheaders","NEXT_RSC_UNION_QUERY","toString","_bodystreams","requestToBodyStream","headerName","_params_request_body1","finalize"],"sources":["../../../../src/server/web/sandbox/sandbox.ts"],"sourcesContent":[null],"mappings":";;;;;;;;;;;;;;;;;EAQaA,WAAW,WAAAA,CAAA;WAAXA,WAAA;;EAuCSC,iBAAiB,WAAAA,CAAA;WAAjBA,iBAAA;;EA2BTC,GAAG,WAAAA,CAAA;WAAHA,GAAA;;;4BAzEkB;yBACE;6BAEG;kCAEC;AAE9B,MAAMF,WAAA,GAAcG,MAAA,CAAO;AAElC,MAAMC,iBAAA,GAAoB,CACxB,kBACA,oBACA,oBACD;AAaD;;;;AAIA,SAASC,iBAAiBC,EAAY;EACpC,OAAQC,MAAA,IACND,EAAA,CAAGC,MAAA,EACAC,IAAI,CAAEC,MAAA;QAEMC,iBAAA;WAFM;MACjB,GAAGD,MAAM;MACTE,SAAS,EAAEF,MAAA,qBAAAC,iBAAA,GAAAD,MAAA,CAAQE,SAAS,qBAAjBD,iBAAA,CAAmBE,KAAK,CAAEC,KAAA;QACnC;QACA,MAAM,IAAAC,WAAA,CAAAC,cAAc,EAACF,KAAA,EAAO;MAC9B;IACF;KACCD,KAAK,CAAEC,KAAA;IACN;IACA,MAAM,IAAAC,WAAA,CAAAC,cAAc,EAACF,KAAA,EAAO;EAC9B;AACN;AAEO,eAAeZ,kBAAkBM,MAQvC;EACC,MAAM;IAAES,OAAO;IAAEC;EAAiB,CAAE,GAAG,MAAM,IAAAC,QAAA,CAAAC,gBAAgB,EAAC;IAC5DC,UAAA,EAAYb,MAAA,CAAOc,IAAI;IACvBC,SAAA,EAAWf,MAAA,CAAOe,SAAS,KAAK,OAAO;IACvCC,QAAA,EAAUhB,MAAA,CAAOgB,QAAQ,KAAK;IAC9BC,iBAAA,EAAmBjB,MAAA,CAAOiB,iBAAiB;IAC3CC,OAAA,EAASlB,MAAA,CAAOkB;EAClB;EAEA,IAAIlB,MAAA,CAAOmB,gBAAgB,EAAE;IAC3BV,OAAA,CAAQW,OAAO,CAACC,UAAU,CAACC,kBAAkB,GAAGtB,MAAA,CAAOmB,gBAAgB;EACzE;EAEA,KAAK,MAAMI,SAAA,IAAavB,MAAA,CAAOwB,KAAK,EAAE;IACpCd,iBAAA,CAAkBa,SAAA;EACpB;EACA,OAAOd,OAAA;AACT;AAEO,MAAMd,GAAA,GAAMG,gBAAA,CAAiB,eAAe2B,oBAAoBzB,MAAM;MAqBvE0B,oBAAA;EApBJ,MAAMjB,OAAA,GAAU,MAAMf,iBAAA,CAAkBM,MAAA;EACxC,MAAM2B,MAAA,GAAS3B,MAAA,CAAO4B,OAAO,CAACC,OAAO,CAAE,yBAAwB,CAAC;EAChE,MAAMC,WAAA,GAAc,OAAOH,MAAA,KAAW,WAAWA,MAAA,CAAOI,KAAK,CAAC,OAAO,EAAE;EACvE,IAAID,WAAA,CAAYE,QAAQ,CAAChC,MAAA,CAAOc,IAAI,GAAG;IACrC,OAAO;MACLV,SAAA,EAAW6B,OAAA,CAAQC,OAAO;MAC1BC,QAAA,EAAU,IAAI1B,OAAA,CAAQW,OAAO,CAACgB,QAAQ,CAAC,MAAM;QAC3CP,OAAA,EAAS;UACP,qBAAqB;QACvB;MACF;IACF;EACF;EAEA,MAAMQ,YAAA,GAGJ5B,OAAA,CAAQW,OAAO,CAACkB,QAAQ,CAAE,cAAatC,MAAA,CAAOc,IAAK,EAAC,CAAC,CAACyB,OAAO;EAE/D,MAAMC,MAAA,GAAS,CAAC,CAAC,QAAQ,MAAM,CAACR,QAAQ,CAAChC,MAAA,CAAO4B,OAAO,CAACa,MAAM,KAC1Df,oBAAA,GAAA1B,MAAA,CAAO4B,OAAO,CAACc,IAAI,qBAAnBhB,oBAAA,CAAqBiB,eAAe,KACpCC,SAAA;EAEJ,MAAMC,WAAA,GAAcpC,OAAA,CAAQqC,QAAQ,CAAC;EACrC,MAAMC,WAAA,GAAc,IAAIC,GAAA,CAAIhD,MAAA,CAAO4B,OAAO,CAACqB,GAAG;EAC9CF,WAAA,CAAYG,YAAY,CAACC,MAAM,CAACC,iBAAA,CAAAC,oBAAoB;EAEpDrD,MAAA,CAAO4B,OAAO,CAACqB,GAAG,GAAGF,WAAA,CAAYO,QAAQ;EAEzC,IAAI;IACF,MAAMpD,MAAA,GAAS,MAAMmC,YAAA,CAAa;MAChCT,OAAA,EAAS;QACP,GAAG5B,MAAA,CAAO4B,OAAO;QACjBc,IAAA,EACEF,MAAA,IAAU,IAAAe,YAAA,CAAAC,mBAAmB,EAAC/C,OAAA,CAAQW,OAAO,EAAEyB,WAAA,EAAaL,MAAA;MAChE;IACF;IACA,KAAK,MAAMiB,UAAA,IAAc5D,iBAAA,EAAmB;MAC1CK,MAAA,CAAOiC,QAAQ,CAACN,OAAO,CAACsB,MAAM,CAACM,UAAA;IACjC;IACA,OAAOvD,MAAA;EACT,UAAU;QACFwD,qBAAA;IAAN,QAAMA,qBAAA,GAAA1D,MAAA,CAAO4B,OAAO,CAACc,IAAI,qBAAnBgB,qBAAA,CAAqBC,QAAQ;EACrC;AACF"},"metadata":{},"sourceType":"script","externalDependencies":[]}
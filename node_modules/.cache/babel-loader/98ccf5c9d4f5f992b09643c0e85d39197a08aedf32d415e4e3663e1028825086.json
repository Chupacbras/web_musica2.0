{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports,\n// config to parsing pageConfig for client bundles\n\"default\", {\n  enumerable: true,\n  get: function () {\n    return nextPageConfig;\n  }\n});\nconst _core = require(\"next/dist/compiled/babel/core\");\nconst _constants = require(\"../../../shared/lib/constants\");\nconst CONFIG_KEY = \"config\";\n// replace program path with just a variable with the drop identifier\nfunction replaceBundle(path, t) {\n  path.parentPath.replaceWith(t.program([t.variableDeclaration(\"const\", [t.variableDeclarator(t.identifier(_constants.STRING_LITERAL_DROP_BUNDLE), t.stringLiteral(`${_constants.STRING_LITERAL_DROP_BUNDLE} ${Date.now()}`))])], []));\n}\nfunction errorMessage(state, details) {\n  const pageName = (state.filename || \"\").split(state.cwd || \"\").pop() || \"unknown\";\n  return `Invalid page config export found. ${details} in file ${pageName}. See: https://nextjs.org/docs/messages/invalid-page-config`;\n}\nfunction nextPageConfig({\n  types: t\n}) {\n  return {\n    visitor: {\n      Program: {\n        enter(path, state) {\n          path.traverse({\n            ExportDeclaration(exportPath, exportState) {\n              var _exportPath_node_specifiers;\n              if (_core.types.isExportNamedDeclaration(exportPath) && ((_exportPath_node_specifiers = exportPath.node.specifiers) == null ? void 0 : _exportPath_node_specifiers.some(specifier => {\n                return (t.isIdentifier(specifier.exported) ? specifier.exported.name : specifier.exported.value) === CONFIG_KEY;\n              })) && _core.types.isStringLiteral(exportPath.node.source)) {\n                throw new Error(errorMessage(exportState, \"Expected object but got export from\"));\n              }\n            },\n            ExportNamedDeclaration(exportPath, exportState) {\n              var _exportPath_node_declaration, _exportPath_scope_getBinding;\n              if (exportState.bundleDropped || !exportPath.node.declaration && exportPath.node.specifiers.length === 0) {\n                return;\n              }\n              const config = {};\n              const declarations = [...(((_exportPath_node_declaration = exportPath.node.declaration) == null ? void 0 : _exportPath_node_declaration.declarations) || []), (_exportPath_scope_getBinding = exportPath.scope.getBinding(CONFIG_KEY)) == null ? void 0 : _exportPath_scope_getBinding.path.node].filter(Boolean);\n              for (const specifier of exportPath.node.specifiers) {\n                if ((t.isIdentifier(specifier.exported) ? specifier.exported.name : specifier.exported.value) === CONFIG_KEY) {\n                  // export {} from 'somewhere'\n                  if (_core.types.isStringLiteral(exportPath.node.source)) {\n                    throw new Error(errorMessage(exportState, `Expected object but got import`));\n                    // import hello from 'world'\n                    // export { hello as config }\n                  } else if (_core.types.isIdentifier(specifier.local)) {\n                    var _exportPath_scope_getBinding1;\n                    if (_core.types.isImportSpecifier((_exportPath_scope_getBinding1 = exportPath.scope.getBinding(specifier.local.name)) == null ? void 0 : _exportPath_scope_getBinding1.path.node)) {\n                      throw new Error(errorMessage(exportState, `Expected object but got import`));\n                    }\n                  }\n                }\n              }\n              for (const declaration of declarations) {\n                if (!_core.types.isIdentifier(declaration.id, {\n                  name: CONFIG_KEY\n                })) {\n                  continue;\n                }\n                let {\n                  init\n                } = declaration;\n                if (_core.types.isTSAsExpression(init)) {\n                  init = init.expression;\n                }\n                if (!_core.types.isObjectExpression(init)) {\n                  const got = init ? init.type : \"undefined\";\n                  throw new Error(errorMessage(exportState, `Expected object but got ${got}`));\n                }\n                for (const prop of init.properties) {\n                  if (_core.types.isSpreadElement(prop)) {\n                    throw new Error(errorMessage(exportState, `Property spread is not allowed`));\n                  }\n                  const {\n                    name\n                  } = prop.key;\n                  if (_core.types.isIdentifier(prop.key, {\n                    name: \"amp\"\n                  })) {\n                    if (!_core.types.isObjectProperty(prop)) {\n                      throw new Error(errorMessage(exportState, `Invalid property \"${name}\"`));\n                    }\n                    if (!_core.types.isBooleanLiteral(prop.value) && !_core.types.isStringLiteral(prop.value)) {\n                      throw new Error(errorMessage(exportState, `Invalid value for \"${name}\"`));\n                    }\n                    config.amp = prop.value.value;\n                  }\n                }\n              }\n              if (config.amp === true) {\n                var _exportState_file_opts, _exportState_file;\n                if (!((_exportState_file = exportState.file) == null ? void 0 : (_exportState_file_opts = _exportState_file.opts) == null ? void 0 : _exportState_file_opts.caller.isDev)) {\n                  // don't replace bundle in development so HMR can track\n                  // dependencies and trigger reload when they are changed\n                  replaceBundle(exportPath, t);\n                }\n                exportState.bundleDropped = true;\n                return;\n              }\n            }\n          }, state);\n        }\n      }\n    }\n  };\n}","map":{"version":3,"names":["nextPageConfig","CONFIG_KEY","replaceBundle","path","t","parentPath","replaceWith","program","variableDeclaration","variableDeclarator","identifier","_constants","STRING_LITERAL_DROP_BUNDLE","stringLiteral","Date","now","errorMessage","state","details","pageName","filename","split","cwd","pop","types","visitor","Program","enter","traverse","ExportDeclaration","exportPath","exportState","_exportPath_node_specifiers","_core","isExportNamedDeclaration","node","specifiers","some","specifier","isIdentifier","exported","name","value","isStringLiteral","source","Error","ExportNamedDeclaration","_exportPath_node_declaration","_exportPath_scope_getBinding","bundleDropped","declaration","length","config","declarations","scope","getBinding","filter","Boolean","local","_exportPath_scope_getBinding1","isImportSpecifier","id","init","isTSAsExpression","expression","isObjectExpression","got","type","prop","properties","isSpreadElement","key","isObjectProperty","isBooleanLiteral","amp","_exportState_file_opts","_exportState_file","file","opts","caller","isDev"],"sources":["../../../../src/build/babel/plugins/next-page-config.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}
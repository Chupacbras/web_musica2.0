{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"useFlightResponse\", {\n  enumerable: true,\n  get: function () {\n    return useFlightResponse;\n  }\n});\nconst _encodedecode = require(\"../stream-utils/encode-decode\");\nconst _htmlescape = require(\"../htmlescape\");\nconst isEdgeRuntime = process.env.NEXT_RUNTIME === \"edge\";\nfunction useFlightResponse(writable, req, clientReferenceManifest, rscChunks, flightResponseRef, nonce) {\n  if (flightResponseRef.current !== null) {\n    return flightResponseRef.current;\n  }\n  // react-server-dom-webpack/client.edge must not be hoisted for require cache clearing to work correctly\n  const {\n    createFromReadableStream\n  } = require(`react-server-dom-webpack/client.edge`);\n  const [renderStream, forwardStream] = req.tee();\n  const res = createFromReadableStream(renderStream, {\n    moduleMap: isEdgeRuntime ? clientReferenceManifest.edgeSSRModuleMapping : clientReferenceManifest.ssrModuleMapping\n  });\n  flightResponseRef.current = res;\n  let bootstrapped = false;\n  // We only attach CSS chunks to the inlined data.\n  const forwardReader = forwardStream.getReader();\n  const writer = writable.getWriter();\n  const startScriptTag = nonce ? `<script nonce=${JSON.stringify(nonce)}>` : \"<script>\";\n  const textDecoder = new TextDecoder();\n  function read() {\n    forwardReader.read().then(({\n      done,\n      value\n    }) => {\n      if (value) {\n        rscChunks.push(value);\n      }\n      if (!bootstrapped) {\n        bootstrapped = true;\n        writer.write((0, _encodedecode.encodeText)(`${startScriptTag}(self.__next_f=self.__next_f||[]).push(${(0, _htmlescape.htmlEscapeJsonString)(JSON.stringify([0]))})</script>`));\n      }\n      if (done) {\n        // Add a setTimeout here because the error component is too small, the first forwardReader.read() read will return the full chunk\n        // and then it immediately set flightResponseRef.current as null.\n        // react renders the component twice, the second render will run into the state with useFlightResponse where flightResponseRef.current is null,\n        // so it tries to render the flight payload again\n        setTimeout(() => {\n          flightResponseRef.current = null;\n        });\n        writer.close();\n      } else {\n        const responsePartial = (0, _encodedecode.decodeText)(value, textDecoder);\n        const scripts = `${startScriptTag}self.__next_f.push(${(0, _htmlescape.htmlEscapeJsonString)(JSON.stringify([1, responsePartial]))})</script>`;\n        writer.write((0, _encodedecode.encodeText)(scripts));\n        read();\n      }\n    });\n  }\n  read();\n  return res;\n}","map":{"version":3,"names":["useFlightResponse","isEdgeRuntime","process","env","NEXT_RUNTIME","writable","req","clientReferenceManifest","rscChunks","flightResponseRef","nonce","current","createFromReadableStream","require","renderStream","forwardStream","tee","res","moduleMap","edgeSSRModuleMapping","ssrModuleMapping","bootstrapped","forwardReader","getReader","writer","getWriter","startScriptTag","JSON","stringify","textDecoder","TextDecoder","read","then","done","value","push","write","_encodedecode","encodeText","_htmlescape","htmlEscapeJsonString","setTimeout","close","responsePartial","decodeText","scripts"],"sources":["../../../src/server/app-render/use-flight-response.tsx"],"sourcesContent":[null],"mappings":";;;;;+BAWgB;;;WAAAA,iBAAA;;;8BATuB;4BACF;AAErC,MAAMC,aAAA,GAAgBC,OAAA,CAAQC,GAAG,CAACC,YAAY,KAAK;AAM5C,SAASJ,kBACdK,QAAoC,EACpCC,GAA+B,EAC/BC,uBAAgD,EAChDC,SAAuB,EACvBC,iBAAoC,EACpCC,KAAc;EAEd,IAAID,iBAAA,CAAkBE,OAAO,KAAK,MAAM;IACtC,OAAOF,iBAAA,CAAkBE,OAAO;EAClC;EACA;EACA,MAAM;IACJC;EAAwB,CACzB,GAAGC,OAAA,CAAS,sCAAqC;EAElD,MAAM,CAACC,YAAA,EAAcC,aAAA,CAAc,GAAGT,GAAA,CAAIU,GAAG;EAC7C,MAAMC,GAAA,GAAML,wBAAA,CAAyBE,YAAA,EAAc;IACjDI,SAAA,EAAWjB,aAAA,GACPM,uBAAA,CAAwBY,oBAAoB,GAC5CZ,uBAAA,CAAwBa;EAC9B;EACAX,iBAAA,CAAkBE,OAAO,GAAGM,GAAA;EAE5B,IAAII,YAAA,GAAe;EACnB;EACA,MAAMC,aAAA,GAAgBP,aAAA,CAAcQ,SAAS;EAC7C,MAAMC,MAAA,GAASnB,QAAA,CAASoB,SAAS;EACjC,MAAMC,cAAA,GAAiBhB,KAAA,GAClB,iBAAgBiB,IAAA,CAAKC,SAAS,CAAClB,KAAA,CAAO,GAAE,GACzC;EACJ,MAAMmB,WAAA,GAAc,IAAIC,WAAA;EAExB,SAASC,KAAA;IACPT,aAAA,CAAcS,IAAI,GAAGC,IAAI,CAAC,CAAC;MAAEC,IAAI;MAAEC;IAAK,CAAE;MACxC,IAAIA,KAAA,EAAO;QACT1B,SAAA,CAAU2B,IAAI,CAACD,KAAA;MACjB;MAEA,IAAI,CAACb,YAAA,EAAc;QACjBA,YAAA,GAAe;QACfG,MAAA,CAAOY,KAAK,CACV,IAAAC,aAAA,CAAAC,UAAU,EACP,GAAEZ,cAAe,0CAAyC,IAAAa,WAAA,CAAAC,oBAAoB,EAC7Eb,IAAA,CAAKC,SAAS,CAAC,CAAC,EAAE,EAClB,YAAW;MAGnB;MACA,IAAIK,IAAA,EAAM;QACR;QACA;QACA;QACA;QACAQ,UAAA,CAAW;UACThC,iBAAA,CAAkBE,OAAO,GAAG;QAC9B;QACAa,MAAA,CAAOkB,KAAK;MACd,OAAO;QACL,MAAMC,eAAA,GAAkB,IAAAN,aAAA,CAAAO,UAAU,EAACV,KAAA,EAAOL,WAAA;QAC1C,MAAMgB,OAAA,GAAW,GAAEnB,cAAe,sBAAqB,IAAAa,WAAA,CAAAC,oBAAoB,EACzEb,IAAA,CAAKC,SAAS,CAAC,CAAC,GAAGe,eAAA,CAAgB,EACnC,YAAW;QAEbnB,MAAA,CAAOY,KAAK,CAAC,IAAAC,aAAA,CAAAC,UAAU,EAACO,OAAA;QACxBd,IAAA;MACF;IACF;EACF;EACAA,IAAA;EAEA,OAAOd,GAAA;AACT"},"metadata":{},"sourceType":"script","externalDependencies":[]}
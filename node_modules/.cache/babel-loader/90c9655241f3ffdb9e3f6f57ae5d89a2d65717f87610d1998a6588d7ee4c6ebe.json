{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"recursiveDelete\", {\n  enumerable: true,\n  get: function () {\n    return recursiveDelete;\n  }\n});\nconst _fs = require(\"fs\");\nconst _path = require(\"path\");\nconst _iserror = /*#__PURE__*/_interop_require_default(require(\"./is-error\"));\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nconst sleep = timeout => new Promise(resolve => setTimeout(resolve, timeout));\nconst unlinkPath = async (p, isDir = false, t = 1) => {\n  try {\n    if (isDir) {\n      await _fs.promises.rmdir(p);\n    } else {\n      await _fs.promises.unlink(p);\n    }\n  } catch (e) {\n    const code = (0, _iserror.default)(e) && e.code;\n    if ((code === \"EBUSY\" || code === \"ENOTEMPTY\" || code === \"EPERM\" || code === \"EMFILE\") && t < 3) {\n      await sleep(t * 100);\n      return unlinkPath(p, isDir, t++);\n    }\n    if (code === \"ENOENT\") {\n      return;\n    }\n    throw e;\n  }\n};\nasync function recursiveDelete( /** Directory to delete the contents of */dir, /** Exclude based on relative file path */exclude, /** Ensures that parameter dir exists, this is not passed recursively */previousPath = \"\") {\n  let result;\n  try {\n    result = await _fs.promises.readdir(dir, {\n      withFileTypes: true\n    });\n  } catch (e) {\n    if ((0, _iserror.default)(e) && e.code === \"ENOENT\") {\n      return;\n    }\n    throw e;\n  }\n  await Promise.all(result.map(async part => {\n    const absolutePath = (0, _path.join)(dir, part.name);\n    // readdir does not follow symbolic links\n    // if part is a symbolic link, follow it using stat\n    let isDirectory = part.isDirectory();\n    const isSymlink = part.isSymbolicLink();\n    if (isSymlink) {\n      const linkPath = await _fs.promises.readlink(absolutePath);\n      try {\n        const stats = await _fs.promises.stat((0, _path.isAbsolute)(linkPath) ? linkPath : (0, _path.join)((0, _path.dirname)(absolutePath), linkPath));\n        isDirectory = stats.isDirectory();\n      } catch {}\n    }\n    const pp = (0, _path.join)(previousPath, part.name);\n    const isNotExcluded = !exclude || !exclude.test(pp);\n    if (isNotExcluded) {\n      if (isDirectory) {\n        await recursiveDelete(absolutePath, exclude, pp);\n      }\n      return unlinkPath(absolutePath, !isSymlink && isDirectory);\n    }\n  }));\n}","map":{"version":3,"names":["recursiveDelete","sleep","timeout","Promise","resolve","setTimeout","unlinkPath","p","isDir","t","_fs","promises","rmdir","unlink","e","code","_iserror","default","dir","exclude","previousPath","result","readdir","withFileTypes","all","map","part","absolutePath","_path","join","name","isDirectory","isSymlink","isSymbolicLink","linkPath","readlink","stats","stat","isAbsolute","dirname","pp","isNotExcluded","test"],"sources":["../../src/lib/recursive-delete.ts"],"sourcesContent":[null],"mappings":";;;;;+BAsCsB;;;WAAAA,eAAA;;;oBAtCW;sBACS;+DACtB;;;;;;AAEpB,MAAMC,KAAA,GAASC,OAAA,IACb,IAAIC,OAAA,CAASC,OAAA,IAAYC,UAAA,CAAWD,OAAA,EAASF,OAAA;AAE/C,MAAMI,UAAA,GAAa,MAAAA,CAAOC,CAAA,EAAWC,KAAA,GAAQ,KAAK,EAAEC,CAAA,GAAI,CAAC;EACvD,IAAI;IACF,IAAID,KAAA,EAAO;MACT,MAAME,GAAA,CAAAC,QAAQ,CAACC,KAAK,CAACL,CAAA;IACvB,OAAO;MACL,MAAMG,GAAA,CAAAC,QAAQ,CAACE,MAAM,CAACN,CAAA;IACxB;EACF,EAAE,OAAOO,CAAA,EAAG;IACV,MAAMC,IAAA,GAAO,IAAAC,QAAA,CAAAC,OAAO,EAACH,CAAA,KAAMA,CAAA,CAAEC,IAAI;IACjC,IACE,CAACA,IAAA,KAAS,WACRA,IAAA,KAAS,eACTA,IAAA,KAAS,WACTA,IAAA,KAAS,QAAO,KAClBN,CAAA,GAAI,GACJ;MACA,MAAMR,KAAA,CAAMQ,CAAA,GAAI;MAChB,OAAOH,UAAA,CAAWC,CAAA,EAAGC,KAAA,EAAOC,CAAA;IAC9B;IAEA,IAAIM,IAAA,KAAS,UAAU;MACrB;IACF;IAEA,MAAMD,CAAA;EACR;AACF;AAKO,eAAed,gBAAA,CACpB,0CACAkB,GAAW,EACX,0CACAC,OAAgB,EAChB,wEACAC,YAAA,GAAuB,EAAE;EAEzB,IAAIC,MAAA;EACJ,IAAI;IACFA,MAAA,GAAS,MAAMX,GAAA,CAAAC,QAAQ,CAACW,OAAO,CAACJ,GAAA,EAAK;MAAEK,aAAA,EAAe;IAAK;EAC7D,EAAE,OAAOT,CAAA,EAAG;IACV,IAAI,IAAAE,QAAA,CAAAC,OAAO,EAACH,CAAA,KAAMA,CAAA,CAAEC,IAAI,KAAK,UAAU;MACrC;IACF;IACA,MAAMD,CAAA;EACR;EAEA,MAAMX,OAAA,CAAQqB,GAAG,CACfH,MAAA,CAAOI,GAAG,CAAC,MAAOC,IAAA;IAChB,MAAMC,YAAA,GAAe,IAAAC,KAAA,CAAAC,IAAI,EAACX,GAAA,EAAKQ,IAAA,CAAKI,IAAI;IAExC;IACA;IACA,IAAIC,WAAA,GAAcL,IAAA,CAAKK,WAAW;IAClC,MAAMC,SAAA,GAAYN,IAAA,CAAKO,cAAc;IAErC,IAAID,SAAA,EAAW;MACb,MAAME,QAAA,GAAW,MAAMxB,GAAA,CAAAC,QAAQ,CAACwB,QAAQ,CAACR,YAAA;MAEzC,IAAI;QACF,MAAMS,KAAA,GAAQ,MAAM1B,GAAA,CAAAC,QAAQ,CAAC0B,IAAI,CAC/B,IAAAT,KAAA,CAAAU,UAAU,EAACJ,QAAA,IACPA,QAAA,GACA,IAAAN,KAAA,CAAAC,IAAI,EAAC,IAAAD,KAAA,CAAAW,OAAO,EAACZ,YAAA,GAAeO,QAAA;QAElCH,WAAA,GAAcK,KAAA,CAAML,WAAW;MACjC,EAAE,MAAM,CAAC;IACX;IAEA,MAAMS,EAAA,GAAK,IAAAZ,KAAA,CAAAC,IAAI,EAACT,YAAA,EAAcM,IAAA,CAAKI,IAAI;IACvC,MAAMW,aAAA,GAAgB,CAACtB,OAAA,IAAW,CAACA,OAAA,CAAQuB,IAAI,CAACF,EAAA;IAEhD,IAAIC,aAAA,EAAe;MACjB,IAAIV,WAAA,EAAa;QACf,MAAM/B,eAAA,CAAgB2B,YAAA,EAAcR,OAAA,EAASqB,EAAA;MAC/C;MACA,OAAOlC,UAAA,CAAWqB,YAAA,EAAc,CAACK,SAAA,IAAaD,WAAA;IAChD;EACF;AAEJ"},"metadata":{},"sourceType":"script","externalDependencies":[]}
{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"patchIncorrectLockfile\", {\n  enumerable: true,\n  get: function () {\n    return patchIncorrectLockfile;\n  }\n});\nconst _fs = require(\"fs\");\nrequire(\"../server/node-polyfill-fetch\");\nconst _log = /*#__PURE__*/_interop_require_wildcard(require(\"../build/output/log\"));\nconst _findup = /*#__PURE__*/_interop_require_default(require(\"next/dist/compiled/find-up\"));\nconst _packagejson = /*#__PURE__*/_interop_require_default(require(\"next/package.json\"));\nconst _ciinfo = require(\"../telemetry/ci-info\");\nconst _getregistry = require(\"./helpers/get-registry\");\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function (nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\nfunction _interop_require_wildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      default: obj\n    };\n  }\n  var cache = _getRequireWildcardCache(nodeInterop);\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n  newObj.default = obj;\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n  return newObj;\n}\nlet registry;\nasync function fetchPkgInfo(pkg) {\n  if (!registry) registry = (0, _getregistry.getRegistry)();\n  const res = await fetch(`${registry}${pkg}`);\n  if (!res.ok) {\n    throw new Error(`Failed to fetch registry info for ${pkg}, got status ${res.status}`);\n  }\n  const data = await res.json();\n  const versionData = data.versions[_packagejson.default.version];\n  return {\n    os: versionData.os,\n    cpu: versionData.cpu,\n    engines: versionData.engines,\n    tarball: versionData.dist.tarball,\n    integrity: versionData.dist.integrity\n  };\n}\nasync function patchIncorrectLockfile(dir) {\n  if (process.env.NEXT_IGNORE_INCORRECT_LOCKFILE) {\n    return;\n  }\n  const lockfilePath = await (0, _findup.default)(\"package-lock.json\", {\n    cwd: dir\n  });\n  if (!lockfilePath) {\n    // if no lockfile present there is no action to take\n    return;\n  }\n  const content = await _fs.promises.readFile(lockfilePath, \"utf8\");\n  // maintain current line ending\n  const endingNewline = content.endsWith(\"\\r\\n\") ? \"\\r\\n\" : content.endsWith(\"\\n\") ? \"\\n\" : \"\";\n  const lockfileParsed = JSON.parse(content);\n  const lockfileVersion = parseInt(lockfileParsed == null ? void 0 : lockfileParsed.lockfileVersion, 10);\n  const expectedSwcPkgs = Object.keys(_packagejson.default[\"optionalDependencies\"] || {});\n  const patchDependency = (pkg, pkgData) => {\n    lockfileParsed.dependencies[pkg] = {\n      version: _packagejson.default.version,\n      resolved: pkgData.tarball,\n      integrity: pkgData.integrity,\n      optional: true\n    };\n  };\n  const patchPackage = (pkg, pkgData) => {\n    lockfileParsed.packages[pkg] = {\n      version: _packagejson.default.version,\n      resolved: pkgData.tarball,\n      integrity: pkgData.integrity,\n      cpu: pkgData.cpu,\n      optional: true,\n      os: pkgData.os,\n      engines: pkgData.engines\n    };\n  };\n  try {\n    const supportedVersions = [1, 2, 3];\n    if (!supportedVersions.includes(lockfileVersion)) {\n      // bail on unsupported version\n      return;\n    }\n    // v1 only uses dependencies\n    // v2 uses dependencies and packages\n    // v3 only uses packages\n    const shouldPatchDependencies = lockfileVersion === 1 || lockfileVersion === 2;\n    const shouldPatchPackages = lockfileVersion === 2 || lockfileVersion === 3;\n    if (shouldPatchDependencies && !lockfileParsed.dependencies || shouldPatchPackages && !lockfileParsed.packages) {\n      // invalid lockfile so bail\n      return;\n    }\n    const missingSwcPkgs = [];\n    let pkgPrefix;\n    if (shouldPatchPackages) {\n      pkgPrefix = \"\";\n      for (const pkg of Object.keys(lockfileParsed.packages)) {\n        if (pkg.endsWith(\"node_modules/next\")) {\n          pkgPrefix = pkg.substring(0, pkg.length - 4);\n        }\n      }\n      if (!pkgPrefix) {\n        // unable to locate the next package so bail\n        return;\n      }\n    }\n    for (const pkg of expectedSwcPkgs) {\n      if (shouldPatchDependencies && !lockfileParsed.dependencies[pkg] || shouldPatchPackages && !lockfileParsed.packages[`${pkgPrefix}${pkg}`]) {\n        missingSwcPkgs.push(pkg);\n      }\n    }\n    if (missingSwcPkgs.length === 0) {\n      return;\n    }\n    _log.warn(`Found lockfile missing swc dependencies,`, _ciinfo.isCI ? \"run next locally to automatically patch\" : \"patching...\");\n    if (_ciinfo.isCI) {\n      // no point in updating in CI as the user can't save the patch\n      return;\n    }\n    const pkgsData = await Promise.all(missingSwcPkgs.map(pkg => fetchPkgInfo(pkg)));\n    for (let i = 0; i < pkgsData.length; i++) {\n      const pkg = missingSwcPkgs[i];\n      const pkgData = pkgsData[i];\n      if (shouldPatchDependencies) {\n        patchDependency(pkg, pkgData);\n      }\n      if (shouldPatchPackages) {\n        patchPackage(`${pkgPrefix}${pkg}`, pkgData);\n      }\n    }\n    await _fs.promises.writeFile(lockfilePath, JSON.stringify(lockfileParsed, null, 2) + endingNewline);\n    _log.warn('Lockfile was successfully patched, please run \"npm install\" to ensure @next/swc dependencies are downloaded');\n  } catch (err) {\n    _log.error(`Failed to patch lockfile, please try uninstalling and reinstalling next in this workspace`);\n    console.error(err);\n  }\n}","map":{"version":3,"names":["patchIncorrectLockfile","registry","fetchPkgInfo","pkg","_getregistry","getRegistry","res","fetch","ok","Error","status","data","json","versionData","versions","_packagejson","default","version","os","cpu","engines","tarball","dist","integrity","dir","process","env","NEXT_IGNORE_INCORRECT_LOCKFILE","lockfilePath","_findup","cwd","content","_fs","promises","readFile","endingNewline","endsWith","lockfileParsed","JSON","parse","lockfileVersion","parseInt","expectedSwcPkgs","Object","keys","patchDependency","pkgData","dependencies","resolved","optional","patchPackage","packages","supportedVersions","includes","shouldPatchDependencies","shouldPatchPackages","missingSwcPkgs","pkgPrefix","substring","length","push","_log","warn","_ciinfo","isCI","pkgsData","Promise","all","map","i","writeFile","stringify","err","error","console"],"sources":["../../src/lib/patch-incorrect-lockfile.ts"],"sourcesContent":[null],"mappings":";;;;;+BAuCsB;;;WAAAA,sBAAA;;;oBAvCG;QAClB;4DACc;8DACF;mEAEK;wBAEH;6BACO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE5B,IAAIC,QAAA;AAEJ,eAAeC,aAAaC,GAAW;EACrC,IAAI,CAACF,QAAA,EAAUA,QAAA,GAAW,IAAAG,YAAA,CAAAC,WAAW;EACrC,MAAMC,GAAA,GAAM,MAAMC,KAAA,CAAO,GAAEN,QAAS,GAAEE,GAAI,EAAC;EAE3C,IAAI,CAACG,GAAA,CAAIE,EAAE,EAAE;IACX,MAAM,IAAIC,KAAA,CACP,qCAAoCN,GAAI,gBAAeG,GAAA,CAAII,MAAO,EAAC;EAExE;EACA,MAAMC,IAAA,GAAO,MAAML,GAAA,CAAIM,IAAI;EAC3B,MAAMC,WAAA,GAAcF,IAAA,CAAKG,QAAQ,CAACC,YAAA,CAAAC,OAAW,CAACC,OAAO,CAAC;EAEtD,OAAO;IACLC,EAAA,EAAIL,WAAA,CAAYK,EAAE;IAClBC,GAAA,EAAKN,WAAA,CAAYM,GAAG;IACpBC,OAAA,EAASP,WAAA,CAAYO,OAAO;IAC5BC,OAAA,EAASR,WAAA,CAAYS,IAAI,CAACD,OAAO;IACjCE,SAAA,EAAWV,WAAA,CAAYS,IAAI,CAACC;EAC9B;AACF;AAQO,eAAevB,uBAAuBwB,GAAW;EACtD,IAAIC,OAAA,CAAQC,GAAG,CAACC,8BAA8B,EAAE;IAC9C;EACF;EACA,MAAMC,YAAA,GAAe,MAAM,IAAAC,OAAA,CAAAb,OAAM,EAAC,qBAAqB;IAAEc,GAAA,EAAKN;EAAI;EAElE,IAAI,CAACI,YAAA,EAAc;IACjB;IACA;EACF;EACA,MAAMG,OAAA,GAAU,MAAMC,GAAA,CAAAC,QAAQ,CAACC,QAAQ,CAACN,YAAA,EAAc;EACtD;EACA,MAAMO,aAAA,GAAgBJ,OAAA,CAAQK,QAAQ,CAAC,UACnC,SACAL,OAAA,CAAQK,QAAQ,CAAC,QACjB,OACA;EAEJ,MAAMC,cAAA,GAAiBC,IAAA,CAAKC,KAAK,CAACR,OAAA;EAClC,MAAMS,eAAA,GAAkBC,QAAA,CAASJ,cAAA,oBAAAA,cAAA,CAAgBG,eAAe,EAAE;EAClE,MAAME,eAAA,GAAkBC,MAAA,CAAOC,IAAI,CAAC7B,YAAA,CAAAC,OAAW,CAAC,uBAAuB,IAAI,CAAC;EAE5E,MAAM6B,eAAA,GAAkBA,CACtB1C,GAAA,EACA2C,OAAA;IAEAT,cAAA,CAAeU,YAAY,CAAC5C,GAAA,CAAI,GAAG;MACjCc,OAAA,EAASF,YAAA,CAAAC,OAAW,CAACC,OAAO;MAC5B+B,QAAA,EAAUF,OAAA,CAAQzB,OAAO;MACzBE,SAAA,EAAWuB,OAAA,CAAQvB,SAAS;MAC5B0B,QAAA,EAAU;IACZ;EACF;EAEA,MAAMC,YAAA,GAAeA,CACnB/C,GAAA,EACA2C,OAAA;IAEAT,cAAA,CAAec,QAAQ,CAAChD,GAAA,CAAI,GAAG;MAC7Bc,OAAA,EAASF,YAAA,CAAAC,OAAW,CAACC,OAAO;MAC5B+B,QAAA,EAAUF,OAAA,CAAQzB,OAAO;MACzBE,SAAA,EAAWuB,OAAA,CAAQvB,SAAS;MAC5BJ,GAAA,EAAK2B,OAAA,CAAQ3B,GAAG;MAChB8B,QAAA,EAAU;MACV/B,EAAA,EAAI4B,OAAA,CAAQ5B,EAAE;MACdE,OAAA,EAAS0B,OAAA,CAAQ1B;IACnB;EACF;EAEA,IAAI;IACF,MAAMgC,iBAAA,GAAoB,CAAC,GAAG,GAAG,EAAE;IAEnC,IAAI,CAACA,iBAAA,CAAkBC,QAAQ,CAACb,eAAA,GAAkB;MAChD;MACA;IACF;IACA;IACA;IACA;IACA,MAAMc,uBAAA,GACJd,eAAA,KAAoB,KAAKA,eAAA,KAAoB;IAC/C,MAAMe,mBAAA,GAAsBf,eAAA,KAAoB,KAAKA,eAAA,KAAoB;IAEzE,IACEc,uBAAC,IAA2B,CAACjB,cAAA,CAAeU,YAAY,IACvDQ,mBAAA,IAAuB,CAAClB,cAAA,CAAec,QAAQ,EAChD;MACA;MACA;IACF;IACA,MAAMK,cAAA,GAAiB,EAAE;IACzB,IAAIC,SAAA;IAEJ,IAAIF,mBAAA,EAAqB;MACvBE,SAAA,GAAY;MACZ,KAAK,MAAMtD,GAAA,IAAOwC,MAAA,CAAOC,IAAI,CAACP,cAAA,CAAec,QAAQ,GAAG;QACtD,IAAIhD,GAAA,CAAIiC,QAAQ,CAAC,sBAAsB;UACrCqB,SAAA,GAAYtD,GAAA,CAAIuD,SAAS,CAAC,GAAGvD,GAAA,CAAIwD,MAAM,GAAG;QAC5C;MACF;MAEA,IAAI,CAACF,SAAA,EAAW;QACd;QACA;MACF;IACF;IAEA,KAAK,MAAMtD,GAAA,IAAOuC,eAAA,EAAiB;MACjC,IACEY,uBAAC,IAA2B,CAACjB,cAAA,CAAeU,YAAY,CAAC5C,GAAA,CAAI,IAC5DoD,mBAAA,IAAuB,CAAClB,cAAA,CAAec,QAAQ,CAAE,GAAEM,SAAU,GAAEtD,GAAI,EAAC,CAAC,EACtE;QACAqD,cAAA,CAAeI,IAAI,CAACzD,GAAA;MACtB;IACF;IACA,IAAIqD,cAAA,CAAeG,MAAM,KAAK,GAAG;MAC/B;IACF;IACAE,IAAA,CAAIC,IAAI,CACL,0CAAyC,EAC1CC,OAAA,CAAAC,IAAI,GAAG,4CAA4C;IAGrD,IAAID,OAAA,CAAAC,IAAI,EAAE;MACR;MACA;IACF;IACA,MAAMC,QAAA,GAAW,MAAMC,OAAA,CAAQC,GAAG,CAChCX,cAAA,CAAeY,GAAG,CAAEjE,GAAA,IAAQD,YAAA,CAAaC,GAAA;IAG3C,KAAK,IAAIkE,CAAA,GAAI,GAAGA,CAAA,GAAIJ,QAAA,CAASN,MAAM,EAAEU,CAAA,IAAK;MACxC,MAAMlE,GAAA,GAAMqD,cAAc,CAACa,CAAA,CAAE;MAC7B,MAAMvB,OAAA,GAAUmB,QAAQ,CAACI,CAAA,CAAE;MAE3B,IAAIf,uBAAA,EAAyB;QAC3BT,eAAA,CAAgB1C,GAAA,EAAK2C,OAAA;MACvB;MACA,IAAIS,mBAAA,EAAqB;QACvBL,YAAA,CAAc,GAAEO,SAAU,GAAEtD,GAAI,EAAC,EAAE2C,OAAA;MACrC;IACF;IAEA,MAAMd,GAAA,CAAAC,QAAQ,CAACqC,SAAS,CACtB1C,YAAA,EACAU,IAAA,CAAKiC,SAAS,CAAClC,cAAA,EAAgB,MAAM,KAAKF,aAAA;IAE5C0B,IAAA,CAAIC,IAAI,CACN;EAEJ,EAAE,OAAOU,GAAA,EAAK;IACZX,IAAA,CAAIY,KAAK,CACN,2FAA0F;IAE7FC,OAAA,CAAQD,KAAK,CAACD,GAAA;EAChB;AACF"},"metadata":{},"sourceType":"script","externalDependencies":[]}
{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"RequestAsyncStorageWrapper\", {\n  enumerable: true,\n  get: function () {\n    return RequestAsyncStorageWrapper;\n  }\n});\nconst _approuterheaders = require(\"../../client/components/app-router-headers\");\nconst _headers = require(\"../web/spec-extension/adapters/headers\");\nconst _requestcookies = require(\"../web/spec-extension/adapters/request-cookies\");\nconst _cookies = require(\"../web/spec-extension/cookies\");\nconst _draftmodeprovider = require(\"./draft-mode-provider\");\nfunction getHeaders(headers) {\n  const cleaned = _headers.HeadersAdapter.from(headers);\n  for (const param of _approuterheaders.FLIGHT_PARAMETERS) {\n    cleaned.delete(param.toString().toLowerCase());\n  }\n  return _headers.HeadersAdapter.seal(cleaned);\n}\nfunction getCookies(headers) {\n  const cookies = new _cookies.RequestCookies(_headers.HeadersAdapter.from(headers));\n  return _requestcookies.RequestCookiesAdapter.seal(cookies);\n}\nfunction getMutableCookies(headers, onUpdateCookies) {\n  const cookies = new _cookies.RequestCookies(_headers.HeadersAdapter.from(headers));\n  return _requestcookies.MutableRequestCookiesAdapter.wrap(cookies, onUpdateCookies);\n}\nconst RequestAsyncStorageWrapper = {\n  /**\n  * Wrap the callback with the given store so it can access the underlying\n  * store using hooks.\n  *\n  * @param storage underlying storage object returned by the module\n  * @param context context to seed the store\n  * @param callback function to call within the scope of the context\n  * @returns the result returned by the callback\n  */\n  wrap(storage, {\n    req,\n    res,\n    renderOpts\n  }, callback) {\n    let previewProps = undefined;\n    if (renderOpts && \"previewProps\" in renderOpts) {\n      // TODO: investigate why previewProps isn't on RenderOpts\n      previewProps = renderOpts.previewProps;\n    }\n    function defaultOnUpdateCookies(cookies) {\n      if (res) {\n        res.setHeader(\"Set-Cookie\", cookies);\n      }\n    }\n    const cache = {};\n    const store = {\n      get headers() {\n        if (!cache.headers) {\n          // Seal the headers object that'll freeze out any methods that could\n          // mutate the underlying data.\n          cache.headers = getHeaders(req.headers);\n        }\n        return cache.headers;\n      },\n      get cookies() {\n        if (!cache.cookies) {\n          // Seal the cookies object that'll freeze out any methods that could\n          // mutate the underlying data.\n          cache.cookies = getCookies(req.headers);\n        }\n        return cache.cookies;\n      },\n      get mutableCookies() {\n        if (!cache.mutableCookies) {\n          cache.mutableCookies = getMutableCookies(req.headers, (renderOpts == null ? void 0 : renderOpts.onUpdateCookies) || (res ? defaultOnUpdateCookies : undefined));\n        }\n        return cache.mutableCookies;\n      },\n      get draftMode() {\n        if (!cache.draftMode) {\n          cache.draftMode = new _draftmodeprovider.DraftModeProvider(previewProps, req, this.cookies, this.mutableCookies);\n        }\n        return cache.draftMode;\n      }\n    };\n    return storage.run(store, callback, store);\n  }\n};","map":{"version":3,"names":["RequestAsyncStorageWrapper","getHeaders","headers","cleaned","_headers","HeadersAdapter","from","param","_approuterheaders","FLIGHT_PARAMETERS","delete","toString","toLowerCase","seal","getCookies","cookies","_cookies","RequestCookies","_requestcookies","RequestCookiesAdapter","getMutableCookies","onUpdateCookies","MutableRequestCookiesAdapter","wrap","storage","req","res","renderOpts","callback","previewProps","undefined","defaultOnUpdateCookies","setHeader","cache","store","mutableCookies","draftMode","_draftmodeprovider","DraftModeProvider","run"],"sources":["../../../src/server/async-storage/request-async-storage-wrapper.ts"],"sourcesContent":[null],"mappings":";;;;;+BAoDa;;;WAAAA,0BAAA;;;kCA5CqB;yBAI3B;gCAKA;yBACyC;mCAEd;AAElC,SAASC,WAAWC,OAAsC;EACxD,MAAMC,OAAA,GAAUC,QAAA,CAAAC,cAAc,CAACC,IAAI,CAACJ,OAAA;EACpC,KAAK,MAAMK,KAAA,IAASC,iBAAA,CAAAC,iBAAiB,EAAE;IACrCN,OAAA,CAAQO,MAAM,CAACH,KAAA,CAAMI,QAAQ,GAAGC,WAAW;EAC7C;EAEA,OAAOR,QAAA,CAAAC,cAAc,CAACQ,IAAI,CAACV,OAAA;AAC7B;AAEA,SAASW,WACPZ,OAAsC;EAEtC,MAAMa,OAAA,GAAU,IAAIC,QAAA,CAAAC,cAAc,CAACb,QAAA,CAAAC,cAAc,CAACC,IAAI,CAACJ,OAAA;EACvD,OAAOgB,eAAA,CAAAC,qBAAqB,CAACN,IAAI,CAACE,OAAA;AACpC;AAEA,SAASK,kBACPlB,OAAsC,EACtCmB,eAA6C;EAE7C,MAAMN,OAAA,GAAU,IAAIC,QAAA,CAAAC,cAAc,CAACb,QAAA,CAAAC,cAAc,CAACC,IAAI,CAACJ,OAAA;EACvD,OAAOgB,eAAA,CAAAI,4BAA4B,CAACC,IAAI,CAACR,OAAA,EAASM,eAAA;AACpD;AAQO,MAAMrB,0BAAA,GAGT;EACF;;;;;;;;;EASAuB,KACEC,OAAwC,EACxC;IAAEC,GAAG;IAAEC,GAAG;IAAEC;EAAU,CAAkB,EACxCC,QAAyC;IAEzC,IAAIC,YAAA,GAA8CC,SAAA;IAElD,IAAIH,UAAA,IAAc,kBAAkBA,UAAA,EAAY;MAC9C;MACAE,YAAA,GAAeF,UAAC,CAAmBE,YAAY;IACjD;IAEA,SAASE,uBAAuBhB,OAAiB;MAC/C,IAAIW,GAAA,EAAK;QACPA,GAAA,CAAIM,SAAS,CAAC,cAAcjB,OAAA;MAC9B;IACF;IAEA,MAAMkB,KAAA,GAKF,CAAC;IAEL,MAAMC,KAAA,GAAsB;MAC1B,IAAIhC,QAAA,EAAU;QACZ,IAAI,CAAC+B,KAAA,CAAM/B,OAAO,EAAE;UAClB;UACA;UACA+B,KAAA,CAAM/B,OAAO,GAAGD,UAAA,CAAWwB,GAAA,CAAIvB,OAAO;QACxC;QAEA,OAAO+B,KAAA,CAAM/B,OAAO;MACtB;MACA,IAAIa,QAAA,EAAU;QACZ,IAAI,CAACkB,KAAA,CAAMlB,OAAO,EAAE;UAClB;UACA;UACAkB,KAAA,CAAMlB,OAAO,GAAGD,UAAA,CAAWW,GAAA,CAAIvB,OAAO;QACxC;QAEA,OAAO+B,KAAA,CAAMlB,OAAO;MACtB;MACA,IAAIoB,eAAA,EAAiB;QACnB,IAAI,CAACF,KAAA,CAAME,cAAc,EAAE;UACzBF,KAAA,CAAME,cAAc,GAAGf,iBAAA,CACrBK,GAAA,CAAIvB,OAAO,EACX,CAAAyB,UAAA,oBAAAA,UAAA,CAAYN,eAAe,MACxBK,GAAA,GAAMK,sBAAA,GAAyBD,SAAQ;QAE9C;QACA,OAAOG,KAAA,CAAME,cAAc;MAC7B;MACA,IAAIC,UAAA,EAAY;QACd,IAAI,CAACH,KAAA,CAAMG,SAAS,EAAE;UACpBH,KAAA,CAAMG,SAAS,GAAG,IAAIC,kBAAA,CAAAC,iBAAiB,CACrCT,YAAA,EACAJ,GAAA,EACA,IAAI,CAACV,OAAO,EACZ,IAAI,CAACoB,cAAc;QAEvB;QAEA,OAAOF,KAAA,CAAMG,SAAS;MACxB;IACF;IAEA,OAAOZ,OAAA,CAAQe,GAAG,CAACL,KAAA,EAAON,QAAA,EAAUM,KAAA;EACtC;AACF"},"metadata":{},"sourceType":"script","externalDependencies":[]}
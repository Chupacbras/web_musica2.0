{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n0 && (module.exports = {\n  default: null,\n  SUPPORTED_NATIVE_MODULES: null,\n  getEdgePolyfilledModules: null,\n  handleWebpackExternalForEdgeRuntime: null\n});\nfunction _export(target, all) {\n  for (var name in all) Object.defineProperty(target, name, {\n    enumerable: true,\n    get: all[name]\n  });\n}\n_export(exports, {\n  default: function () {\n    return MiddlewarePlugin;\n  },\n  SUPPORTED_NATIVE_MODULES: function () {\n    return SUPPORTED_NATIVE_MODULES;\n  },\n  getEdgePolyfilledModules: function () {\n    return getEdgePolyfilledModules;\n  },\n  handleWebpackExternalForEdgeRuntime: function () {\n    return handleWebpackExternalForEdgeRuntime;\n  }\n});\nconst _routeregex = require(\"../../../shared/lib/router/utils/route-regex\");\nconst _getmodulebuildinfo = require(\"../loaders/get-module-build-info\");\nconst _utils = require(\"../../../shared/lib/router/utils\");\nconst _webpack = require(\"next/dist/compiled/webpack/webpack\");\nconst _micromatch = require(\"next/dist/compiled/micromatch\");\nconst _path = /*#__PURE__*/_interop_require_default(require(\"path\"));\nconst _constants = require(\"../../../shared/lib/constants\");\nconst _shared = require(\"../../../trace/shared\");\nconst _events = require(\"../../../telemetry/events\");\nconst _apppaths = require(\"../../../shared/lib/router/utils/app-paths\");\nconst _constants1 = require(\"../../../lib/constants\");\nconst _buildcontext = require(\"../../build-context\");\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nconst KNOWN_SAFE_DYNAMIC_PACKAGES = require(\"../../../lib/known-edge-safe-packages.json\");\nconst NAME = \"MiddlewarePlugin\";\n/**\n * Checks the value of usingIndirectEval and when it is a set of modules it\n * check if any of the modules is actually being used. If the value is\n * simply truthy it will return true.\n */\nfunction isUsingIndirectEvalAndUsedByExports(args) {\n  const {\n    moduleGraph,\n    runtime,\n    module: module1,\n    usingIndirectEval,\n    wp\n  } = args;\n  if (typeof usingIndirectEval === \"boolean\") {\n    return usingIndirectEval;\n  }\n  const exportsInfo = moduleGraph.getExportsInfo(module1);\n  for (const exportName of usingIndirectEval) {\n    if (exportsInfo.getUsed(exportName, runtime) !== wp.UsageState.Unused) {\n      return true;\n    }\n  }\n  return false;\n}\nfunction getEntryFiles(entryFiles, meta, opts) {\n  const files = [];\n  if (meta.edgeSSR) {\n    if (meta.edgeSSR.isServerComponent) {\n      files.push(`server/${_constants.SERVER_REFERENCE_MANIFEST}.js`);\n      if (opts.sriEnabled) {\n        files.push(`server/${_constants.SUBRESOURCE_INTEGRITY_MANIFEST}.js`);\n      }\n      files.push(...entryFiles.filter(file => file.startsWith(\"app/\") && !file.endsWith(\".hot-update.js\")).map(file => \"server/\" + file.replace(\".js\", \"_\" + _constants.CLIENT_REFERENCE_MANIFEST + \".js\")));\n    }\n    files.push(`server/${_constants.MIDDLEWARE_BUILD_MANIFEST}.js`, `server/${_constants.MIDDLEWARE_REACT_LOADABLE_MANIFEST}.js`);\n    files.push(`server/${_constants.NEXT_FONT_MANIFEST}.js`);\n  }\n  if (_buildcontext.NextBuildContext.hasInstrumentationHook) {\n    files.push(`server/edge-${_constants1.INSTRUMENTATION_HOOK_FILENAME}.js`);\n  }\n  if (process.env.NODE_ENV === \"production\") {\n    files.push(_constants.PRERENDER_MANIFEST.replace(\"json\", \"js\"));\n  }\n  files.push(...entryFiles.filter(file => !file.endsWith(\".hot-update.js\")).map(file => \"server/\" + file));\n  return files;\n}\nfunction getCreateAssets(params) {\n  const {\n    compilation,\n    metadataByEntry,\n    opts\n  } = params;\n  return assets => {\n    const middlewareManifest = {\n      sortedMiddleware: [],\n      middleware: {},\n      functions: {},\n      version: 2\n    };\n    for (const entrypoint of compilation.entrypoints.values()) {\n      var _metadata_edgeMiddleware, _metadata_edgeSSR, _metadata_edgeApiFunction, _metadata_edgeSSR1, _metadata_edgeMiddleware1;\n      if (!entrypoint.name) {\n        continue;\n      }\n      // There should always be metadata for the entrypoint.\n      const metadata = metadataByEntry.get(entrypoint.name);\n      const page = (metadata == null ? void 0 : (_metadata_edgeMiddleware = metadata.edgeMiddleware) == null ? void 0 : _metadata_edgeMiddleware.page) || (metadata == null ? void 0 : (_metadata_edgeSSR = metadata.edgeSSR) == null ? void 0 : _metadata_edgeSSR.page) || (metadata == null ? void 0 : (_metadata_edgeApiFunction = metadata.edgeApiFunction) == null ? void 0 : _metadata_edgeApiFunction.page);\n      if (!page) {\n        continue;\n      }\n      const matcherSource = ((_metadata_edgeSSR1 = metadata.edgeSSR) == null ? void 0 : _metadata_edgeSSR1.isAppDir) ? (0, _apppaths.normalizeAppPath)(page) : page;\n      const catchAll = !metadata.edgeSSR && !metadata.edgeApiFunction;\n      const {\n        namedRegex\n      } = (0, _routeregex.getNamedMiddlewareRegex)(matcherSource, {\n        catchAll\n      });\n      const matchers = (metadata == null ? void 0 : (_metadata_edgeMiddleware1 = metadata.edgeMiddleware) == null ? void 0 : _metadata_edgeMiddleware1.matchers) ?? [{\n        regexp: namedRegex,\n        originalSource: page === \"/\" && catchAll ? \"/:path*\" : matcherSource\n      }];\n      const edgeFunctionDefinition = {\n        files: getEntryFiles(entrypoint.getFiles(), metadata, opts),\n        name: entrypoint.name,\n        page: page,\n        matchers,\n        wasm: Array.from(metadata.wasmBindings, ([name, filePath]) => ({\n          name,\n          filePath\n        })),\n        assets: Array.from(metadata.assetBindings, ([name, filePath]) => ({\n          name,\n          filePath\n        })),\n        ...(metadata.regions && {\n          regions: metadata.regions\n        })\n      };\n      if (metadata.edgeApiFunction || metadata.edgeSSR) {\n        middlewareManifest.functions[page] = edgeFunctionDefinition;\n      } else {\n        middlewareManifest.middleware[page] = edgeFunctionDefinition;\n      }\n    }\n    middlewareManifest.sortedMiddleware = (0, _utils.getSortedRoutes)(Object.keys(middlewareManifest.middleware));\n    assets[_constants.MIDDLEWARE_MANIFEST] = new _webpack.sources.RawSource(JSON.stringify(middlewareManifest, null, 2));\n  };\n}\nfunction buildWebpackError({\n  message,\n  loc,\n  compilation,\n  entryModule,\n  parser\n}) {\n  const error = new compilation.compiler.webpack.WebpackError(message);\n  error.name = NAME;\n  const module1 = entryModule ?? (parser == null ? void 0 : parser.state.current);\n  if (module1) {\n    error.module = module1;\n  }\n  error.loc = loc;\n  return error;\n}\nfunction isInMiddlewareLayer(parser) {\n  var _parser_state_module;\n  return ((_parser_state_module = parser.state.module) == null ? void 0 : _parser_state_module.layer) === \"middleware\";\n}\nfunction isNodeJsModule(moduleName) {\n  return require(\"module\").builtinModules.includes(moduleName);\n}\nfunction isDynamicCodeEvaluationAllowed(fileName, middlewareConfig, rootDir) {\n  // Some packages are known to use `eval` but are safe to use in the Edge\n  // Runtime because the dynamic code will never be executed.\n  if (KNOWN_SAFE_DYNAMIC_PACKAGES.some(pkg => fileName.includes(`/node_modules/${pkg}/`.replace(/\\//g, _path.default.sep)))) {\n    return true;\n  }\n  const name = fileName.replace(rootDir ?? \"\", \"\");\n  return (0, _micromatch.isMatch)(name, (middlewareConfig == null ? void 0 : middlewareConfig.unstable_allowDynamicGlobs) ?? []);\n}\nfunction buildUnsupportedApiError({\n  apiName,\n  loc,\n  ...rest\n}) {\n  return buildWebpackError({\n    message: `A Node.js API is used (${apiName} at line: ${loc.start.line}) which is not supported in the Edge Runtime.\nLearn more: https://nextjs.org/docs/api-reference/edge-runtime`,\n    loc,\n    ...rest\n  });\n}\nfunction registerUnsupportedApiHooks(parser, compilation) {\n  for (const expression of _constants.EDGE_UNSUPPORTED_NODE_APIS) {\n    const warnForUnsupportedApi = node => {\n      if (!isInMiddlewareLayer(parser)) {\n        return;\n      }\n      compilation.warnings.push(buildUnsupportedApiError({\n        compilation,\n        parser,\n        apiName: expression,\n        ...node\n      }));\n      return true;\n    };\n    parser.hooks.call.for(expression).tap(NAME, warnForUnsupportedApi);\n    parser.hooks.expression.for(expression).tap(NAME, warnForUnsupportedApi);\n    parser.hooks.callMemberChain.for(expression).tap(NAME, warnForUnsupportedApi);\n    parser.hooks.expressionMemberChain.for(expression).tap(NAME, warnForUnsupportedApi);\n  }\n  const warnForUnsupportedProcessApi = (node, [callee]) => {\n    if (!isInMiddlewareLayer(parser) || callee === \"env\") {\n      return;\n    }\n    compilation.warnings.push(buildUnsupportedApiError({\n      compilation,\n      parser,\n      apiName: `process.${callee}`,\n      ...node\n    }));\n    return true;\n  };\n  parser.hooks.callMemberChain.for(\"process\").tap(NAME, warnForUnsupportedProcessApi);\n  parser.hooks.expressionMemberChain.for(\"process\").tap(NAME, warnForUnsupportedProcessApi);\n}\nfunction getCodeAnalyzer(params) {\n  return parser => {\n    const {\n      dev,\n      compiler: {\n        webpack: wp\n      },\n      compilation\n    } = params;\n    const {\n      hooks\n    } = parser;\n    /**\n    * For an expression this will check the graph to ensure it is being used\n    * by exports. Then it will store in the module buildInfo a boolean to\n    * express that it contains dynamic code and, if it is available, the\n    * module path that is using it.\n    */\n    const handleExpression = () => {\n      if (!isInMiddlewareLayer(parser)) {\n        return;\n      }\n      wp.optimize.InnerGraph.onUsage(parser.state, (used = true) => {\n        const buildInfo = (0, _getmodulebuildinfo.getModuleBuildInfo)(parser.state.module);\n        if (buildInfo.usingIndirectEval === true || used === false) {\n          return;\n        }\n        if (!buildInfo.usingIndirectEval || used === true) {\n          buildInfo.usingIndirectEval = used;\n          return;\n        }\n        buildInfo.usingIndirectEval = new Set([...Array.from(buildInfo.usingIndirectEval), ...Array.from(used)]);\n      });\n    };\n    /**\n    * This expression handler allows to wrap a dynamic code expression with a\n    * function call where we can warn about dynamic code not being allowed\n    * but actually execute the expression.\n    */\n    const handleWrapExpression = expr => {\n      if (!isInMiddlewareLayer(parser)) {\n        return;\n      }\n      const {\n        ConstDependency\n      } = wp.dependencies;\n      const dep1 = new ConstDependency(\"__next_eval__(function() { return \", expr.range[0]);\n      dep1.loc = expr.loc;\n      parser.state.module.addPresentationalDependency(dep1);\n      const dep2 = new ConstDependency(\"})\", expr.range[1]);\n      dep2.loc = expr.loc;\n      parser.state.module.addPresentationalDependency(dep2);\n      handleExpression();\n      return true;\n    };\n    /**\n    * This expression handler allows to wrap a WebAssembly.compile invocation with a\n    * function call where we can warn about WASM code generation not being allowed\n    * but actually execute the expression.\n    */\n    const handleWrapWasmCompileExpression = expr => {\n      if (!isInMiddlewareLayer(parser)) {\n        return;\n      }\n      const {\n        ConstDependency\n      } = wp.dependencies;\n      const dep1 = new ConstDependency(\"__next_webassembly_compile__(function() { return \", expr.range[0]);\n      dep1.loc = expr.loc;\n      parser.state.module.addPresentationalDependency(dep1);\n      const dep2 = new ConstDependency(\"})\", expr.range[1]);\n      dep2.loc = expr.loc;\n      parser.state.module.addPresentationalDependency(dep2);\n      handleExpression();\n    };\n    /**\n    * This expression handler allows to wrap a WebAssembly.instatiate invocation with a\n    * function call where we can warn about WASM code generation not being allowed\n    * but actually execute the expression.\n    *\n    * Note that we don't update `usingIndirectEval`, i.e. we don't abort a production build\n    * since we can't determine statically if the first parameter is a module (legit use) or\n    * a buffer (dynamic code generation).\n    */\n    const handleWrapWasmInstantiateExpression = expr => {\n      if (!isInMiddlewareLayer(parser)) {\n        return;\n      }\n      if (dev) {\n        const {\n          ConstDependency\n        } = wp.dependencies;\n        const dep1 = new ConstDependency(\"__next_webassembly_instantiate__(function() { return \", expr.range[0]);\n        dep1.loc = expr.loc;\n        parser.state.module.addPresentationalDependency(dep1);\n        const dep2 = new ConstDependency(\"})\", expr.range[1]);\n        dep2.loc = expr.loc;\n        parser.state.module.addPresentationalDependency(dep2);\n      }\n    };\n    /**\n    * Handler to store original source location of static and dynamic imports into module's buildInfo.\n    */\n    const handleImport = node => {\n      var _node_source;\n      if (isInMiddlewareLayer(parser) && ((_node_source = node.source) == null ? void 0 : _node_source.value) && (node == null ? void 0 : node.loc)) {\n        var _node_source_value;\n        const {\n          module: module1,\n          source\n        } = parser.state;\n        const buildInfo = (0, _getmodulebuildinfo.getModuleBuildInfo)(module1);\n        if (!buildInfo.importLocByPath) {\n          buildInfo.importLocByPath = new Map();\n        }\n        const importedModule = (_node_source_value = node.source.value) == null ? void 0 : _node_source_value.toString();\n        buildInfo.importLocByPath.set(importedModule, {\n          sourcePosition: {\n            ...node.loc.start,\n            source: module1.identifier()\n          },\n          sourceContent: source.toString()\n        });\n        if (!dev && isNodeJsModule(importedModule)) {\n          compilation.warnings.push(buildWebpackError({\n            message: `A Node.js module is loaded ('${importedModule}' at line ${node.loc.start.line}) which is not supported in the Edge Runtime.\nLearn More: https://nextjs.org/docs/messages/node-module-in-edge-runtime`,\n            compilation,\n            parser,\n            ...node\n          }));\n        }\n      }\n    };\n    /**\n    * A noop handler to skip analyzing some cases.\n    * Order matters: for it to work, it must be registered first\n    */\n    const skip = () => isInMiddlewareLayer(parser) ? true : undefined;\n    for (const prefix of [\"\", \"global.\"]) {\n      hooks.expression.for(`${prefix}Function.prototype`).tap(NAME, skip);\n      hooks.expression.for(`${prefix}Function.bind`).tap(NAME, skip);\n      hooks.call.for(`${prefix}eval`).tap(NAME, handleWrapExpression);\n      hooks.call.for(`${prefix}Function`).tap(NAME, handleWrapExpression);\n      hooks.new.for(`${prefix}Function`).tap(NAME, handleWrapExpression);\n      hooks.call.for(`${prefix}WebAssembly.compile`).tap(NAME, handleWrapWasmCompileExpression);\n      hooks.call.for(`${prefix}WebAssembly.instantiate`).tap(NAME, handleWrapWasmInstantiateExpression);\n    }\n    hooks.importCall.tap(NAME, handleImport);\n    hooks.import.tap(NAME, handleImport);\n    if (!dev) {\n      // do not issue compilation warning on dev: invoking code will provide details\n      registerUnsupportedApiHooks(parser, compilation);\n    }\n  };\n}\nfunction getExtractMetadata(params) {\n  const {\n    dev,\n    compilation,\n    metadataByEntry,\n    compiler\n  } = params;\n  const {\n    webpack: wp\n  } = compiler;\n  return async () => {\n    metadataByEntry.clear();\n    const telemetry = _shared.traceGlobals.get(\"telemetry\");\n    for (const [entryName, entry] of compilation.entries) {\n      var _entry_dependencies, _route_middlewareConfig;\n      if (entry.options.runtime !== _constants.EDGE_RUNTIME_WEBPACK) {\n        continue;\n      }\n      const entryDependency = (_entry_dependencies = entry.dependencies) == null ? void 0 : _entry_dependencies[0];\n      const {\n        rootDir,\n        route\n      } = (0, _getmodulebuildinfo.getModuleBuildInfo)(compilation.moduleGraph.getResolvedModule(entryDependency));\n      const {\n        moduleGraph\n      } = compilation;\n      const modules = new Set();\n      const addEntriesFromDependency = dependency => {\n        const module1 = moduleGraph.getModule(dependency);\n        if (module1) {\n          modules.add(module1);\n        }\n      };\n      entry.dependencies.forEach(addEntriesFromDependency);\n      entry.includeDependencies.forEach(addEntriesFromDependency);\n      const entryMetadata = {\n        wasmBindings: new Map(),\n        assetBindings: new Map()\n      };\n      if (route == null ? void 0 : (_route_middlewareConfig = route.middlewareConfig) == null ? void 0 : _route_middlewareConfig.regions) {\n        entryMetadata.regions = route.middlewareConfig.regions;\n      }\n      if (route == null ? void 0 : route.preferredRegion) {\n        const preferredRegion = route.preferredRegion;\n        entryMetadata.regions =\n        // Ensures preferredRegion is always an array in the manifest.\n        typeof preferredRegion === \"string\" ? [preferredRegion] : preferredRegion;\n      }\n      let ogImageGenerationCount = 0;\n      for (const module1 of modules) {\n        const buildInfo = (0, _getmodulebuildinfo.getModuleBuildInfo)(module1);\n        /**\n        * Check if it uses the image generation feature.\n        */\n        if (!dev) {\n          const resource = module1.resource;\n          const hasOGImageGeneration = resource && /[\\\\/]node_modules[\\\\/]@vercel[\\\\/]og[\\\\/]dist[\\\\/]index\\.(edge|node)\\.js$|[\\\\/]next[\\\\/]dist[\\\\/](esm[\\\\/])?server[\\\\/]web[\\\\/]spec-extension[\\\\/]image-response\\.js$/.test(resource);\n          if (hasOGImageGeneration) {\n            ogImageGenerationCount++;\n          }\n        }\n        /**\n        * When building for production checks if the module is using `eval`\n        * and in such case produces a compilation error. The module has to\n        * be in use.\n        */\n        if (!dev && buildInfo.usingIndirectEval && isUsingIndirectEvalAndUsedByExports({\n          module: module1,\n          moduleGraph,\n          runtime: wp.util.runtime.getEntryRuntime(compilation, entryName),\n          usingIndirectEval: buildInfo.usingIndirectEval,\n          wp\n        })) {\n          var _route_middlewareConfig1;\n          const id = module1.identifier();\n          if (/node_modules[\\\\/]regenerator-runtime[\\\\/]runtime\\.js/.test(id)) {\n            continue;\n          }\n          if (route == null ? void 0 : (_route_middlewareConfig1 = route.middlewareConfig) == null ? void 0 : _route_middlewareConfig1.unstable_allowDynamicGlobs) {\n            telemetry == null ? void 0 : telemetry.record({\n              eventName: \"NEXT_EDGE_ALLOW_DYNAMIC_USED\",\n              payload: {\n                file: route == null ? void 0 : route.absolutePagePath.replace(rootDir ?? \"\", \"\"),\n                config: route == null ? void 0 : route.middlewareConfig,\n                fileWithDynamicCode: module1.userRequest.replace(rootDir ?? \"\", \"\")\n              }\n            });\n          }\n          if (!isDynamicCodeEvaluationAllowed(module1.userRequest, route == null ? void 0 : route.middlewareConfig, rootDir)) {\n            compilation.errors.push(buildWebpackError({\n              message: `Dynamic Code Evaluation (e. g. 'eval', 'new Function', 'WebAssembly.compile') not allowed in Edge Runtime ${typeof buildInfo.usingIndirectEval !== \"boolean\" ? `\\nUsed by ${Array.from(buildInfo.usingIndirectEval).join(\", \")}` : \"\"}\\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`,\n              entryModule: module1,\n              compilation\n            }));\n          }\n        }\n        /**\n        * The entry module has to be either a page or a middleware and hold\n        * the corresponding metadata.\n        */\n        if (buildInfo == null ? void 0 : buildInfo.nextEdgeSSR) {\n          entryMetadata.edgeSSR = buildInfo.nextEdgeSSR;\n        } else if (buildInfo == null ? void 0 : buildInfo.nextEdgeMiddleware) {\n          entryMetadata.edgeMiddleware = buildInfo.nextEdgeMiddleware;\n        } else if (buildInfo == null ? void 0 : buildInfo.nextEdgeApiFunction) {\n          entryMetadata.edgeApiFunction = buildInfo.nextEdgeApiFunction;\n        }\n        /**\n        * If the module is a WASM module we read the binding information and\n        * append it to the entry wasm bindings.\n        */\n        if (buildInfo == null ? void 0 : buildInfo.nextWasmMiddlewareBinding) {\n          entryMetadata.wasmBindings.set(buildInfo.nextWasmMiddlewareBinding.name, buildInfo.nextWasmMiddlewareBinding.filePath);\n        }\n        if (buildInfo == null ? void 0 : buildInfo.nextAssetMiddlewareBinding) {\n          entryMetadata.assetBindings.set(buildInfo.nextAssetMiddlewareBinding.name, buildInfo.nextAssetMiddlewareBinding.filePath);\n        }\n        /**\n        * Append to the list of modules to process outgoingConnections from\n        * the module that is being processed.\n        */\n        for (const conn of moduleGraph.getOutgoingConnections(module1)) {\n          if (conn.module) {\n            modules.add(conn.module);\n          }\n        }\n      }\n      telemetry == null ? void 0 : telemetry.record({\n        eventName: _events.EVENT_BUILD_FEATURE_USAGE,\n        payload: {\n          featureName: \"vercelImageGeneration\",\n          invocationCount: ogImageGenerationCount\n        }\n      });\n      metadataByEntry.set(entryName, entryMetadata);\n    }\n  };\n}\nclass MiddlewarePlugin {\n  constructor({\n    dev,\n    sriEnabled\n  }) {\n    this.dev = dev;\n    this.sriEnabled = sriEnabled;\n  }\n  apply(compiler) {\n    compiler.hooks.compilation.tap(NAME, (compilation, params) => {\n      const {\n        hooks\n      } = params.normalModuleFactory;\n      /**\n      * This is the static code analysis phase.\n      */\n      const codeAnalyzer = getCodeAnalyzer({\n        dev: this.dev,\n        compiler,\n        compilation\n      });\n      hooks.parser.for(\"javascript/auto\").tap(NAME, codeAnalyzer);\n      hooks.parser.for(\"javascript/dynamic\").tap(NAME, codeAnalyzer);\n      hooks.parser.for(\"javascript/esm\").tap(NAME, codeAnalyzer);\n      /**\n      * Extract all metadata for the entry points in a Map object.\n      */\n      const metadataByEntry = new Map();\n      compilation.hooks.finishModules.tapPromise(NAME, getExtractMetadata({\n        compilation,\n        compiler,\n        dev: this.dev,\n        metadataByEntry\n      }));\n      /**\n      * Emit the middleware manifest.\n      */\n      compilation.hooks.processAssets.tap({\n        name: \"NextJsMiddlewareManifest\",\n        stage: _webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS\n      }, getCreateAssets({\n        compilation,\n        metadataByEntry,\n        opts: {\n          sriEnabled: this.sriEnabled\n        }\n      }));\n    });\n  }\n}\nconst SUPPORTED_NATIVE_MODULES = [\"buffer\", \"events\", \"assert\", \"util\", \"async_hooks\"];\nconst supportedEdgePolyfills = new Set(SUPPORTED_NATIVE_MODULES);\nfunction getEdgePolyfilledModules() {\n  const records = {};\n  for (const mod of SUPPORTED_NATIVE_MODULES) {\n    records[mod] = `commonjs node:${mod}`;\n    records[`node:${mod}`] = `commonjs node:${mod}`;\n  }\n  return records;\n}\nasync function handleWebpackExternalForEdgeRuntime({\n  request,\n  context,\n  contextInfo,\n  getResolve\n}) {\n  if (contextInfo.issuerLayer === \"middleware\" && isNodeJsModule(request) && !supportedEdgePolyfills.has(request)) {\n    // allows user to provide and use their polyfills, as we do with buffer.\n    try {\n      await getResolve()(context, request);\n    } catch {\n      return `root  globalThis.__import_unsupported('${request}')`;\n    }\n  }\n}","map":{"version":3,"names":["default","MiddlewarePlugin","SUPPORTED_NATIVE_MODULES","getEdgePolyfilledModules","handleWebpackExternalForEdgeRuntime","KNOWN_SAFE_DYNAMIC_PACKAGES","require","NAME","isUsingIndirectEvalAndUsedByExports","args","moduleGraph","runtime","module","module1","usingIndirectEval","wp","exportsInfo","getExportsInfo","exportName","getUsed","UsageState","Unused","getEntryFiles","entryFiles","meta","opts","files","edgeSSR","isServerComponent","push","_constants","SERVER_REFERENCE_MANIFEST","sriEnabled","SUBRESOURCE_INTEGRITY_MANIFEST","filter","file","startsWith","endsWith","map","replace","CLIENT_REFERENCE_MANIFEST","MIDDLEWARE_BUILD_MANIFEST","MIDDLEWARE_REACT_LOADABLE_MANIFEST","NEXT_FONT_MANIFEST","_buildcontext","NextBuildContext","hasInstrumentationHook","_constants1","INSTRUMENTATION_HOOK_FILENAME","process","env","NODE_ENV","PRERENDER_MANIFEST","getCreateAssets","params","compilation","metadataByEntry","assets","middlewareManifest","sortedMiddleware","middleware","functions","version","entrypoint","entrypoints","values","_metadata_edgeMiddleware","_metadata_edgeSSR","_metadata_edgeApiFunction","_metadata_edgeSSR1","_metadata_edgeMiddleware1","name","metadata","get","page","edgeMiddleware","edgeApiFunction","matcherSource","isAppDir","_apppaths","normalizeAppPath","catchAll","namedRegex","_routeregex","getNamedMiddlewareRegex","matchers","regexp","originalSource","edgeFunctionDefinition","getFiles","wasm","Array","from","wasmBindings","filePath","assetBindings","regions","_utils","getSortedRoutes","Object","keys","MIDDLEWARE_MANIFEST","_webpack","sources","RawSource","JSON","stringify","buildWebpackError","message","loc","entryModule","parser","error","compiler","webpack","WebpackError","state","current","isInMiddlewareLayer","_parser_state_module","layer","isNodeJsModule","moduleName","builtinModules","includes","isDynamicCodeEvaluationAllowed","fileName","middlewareConfig","rootDir","some","pkg","_path","sep","_micromatch","isMatch","unstable_allowDynamicGlobs","buildUnsupportedApiError","apiName","rest","start","line","registerUnsupportedApiHooks","expression","EDGE_UNSUPPORTED_NODE_APIS","warnForUnsupportedApi","node","warnings","hooks","call","for","tap","callMemberChain","expressionMemberChain","warnForUnsupportedProcessApi","callee","getCodeAnalyzer","dev","handleExpression","optimize","InnerGraph","onUsage","used","buildInfo","_getmodulebuildinfo","getModuleBuildInfo","Set","handleWrapExpression","expr","ConstDependency","dependencies","dep1","range","addPresentationalDependency","dep2","handleWrapWasmCompileExpression","handleWrapWasmInstantiateExpression","handleImport","_node_source","source","value","_node_source_value","importLocByPath","Map","importedModule","toString","set","sourcePosition","identifier","sourceContent","skip","undefined","prefix","new","importCall","import","getExtractMetadata","clear","telemetry","_shared","traceGlobals","entryName","entry","entries","_entry_dependencies","_route_middlewareConfig","options","EDGE_RUNTIME_WEBPACK","entryDependency","route","getResolvedModule","modules","addEntriesFromDependency","dependency","getModule","add","forEach","includeDependencies","entryMetadata","preferredRegion","ogImageGenerationCount","resource","hasOGImageGeneration","test","util","getEntryRuntime","_route_middlewareConfig1","id","record","eventName","payload","absolutePagePath","config","fileWithDynamicCode","userRequest","errors","join","nextEdgeSSR","nextEdgeMiddleware","nextEdgeApiFunction","nextWasmMiddlewareBinding","nextAssetMiddlewareBinding","conn","getOutgoingConnections","_events","EVENT_BUILD_FEATURE_USAGE","featureName","invocationCount","constructor","apply","normalModuleFactory","codeAnalyzer","finishModules","tapPromise","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS","supportedEdgePolyfills","records","mod","request","context","contextInfo","getResolve","issuerLayer","has"],"sources":["../../../../src/build/webpack/plugins/middleware-plugin.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}
{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n0 && (module.exports = {\n  generatePrefetchRsc: null,\n  exportAppPage: null\n});\nfunction _export(target, all) {\n  for (var name in all) Object.defineProperty(target, name, {\n    enumerable: true,\n    get: all[name]\n  });\n}\n_export(exports, {\n  generatePrefetchRsc: function () {\n    return generatePrefetchRsc;\n  },\n  exportAppPage: function () {\n    return exportAppPage;\n  }\n});\nconst _promises = /*#__PURE__*/_interop_require_default(require(\"fs/promises\"));\nconst _approuterheaders = require(\"../../client/components/app-router-headers\");\nconst _isdynamicusageerror = require(\"../helpers/is-dynamic-usage-error\");\nconst _constants = require(\"../../lib/constants\");\nconst _ciinfo = require(\"../../telemetry/ci-info\");\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n/**\n * Lazily loads and runs the app page render function.\n */\nconst render = (...args) => {\n  return require(\"../../server/future/route-modules/app-page/module.compiled\").renderToHTMLOrFlight(...args);\n};\nasync function generatePrefetchRsc(req, path, res, pathname, query, htmlFilepath, renderOpts) {\n  req.headers[_approuterheaders.RSC.toLowerCase()] = \"1\";\n  req.headers[_approuterheaders.NEXT_URL.toLowerCase()] = path;\n  req.headers[_approuterheaders.NEXT_ROUTER_PREFETCH.toLowerCase()] = \"1\";\n  renderOpts.supportsDynamicHTML = true;\n  delete renderOpts.isRevalidate;\n  const prefetchRenderResult = await render(req, res, pathname, query, renderOpts);\n  prefetchRenderResult.pipe(res);\n  await res.hasStreamed;\n  const prefetchRscData = Buffer.concat(res.buffers);\n  await _promises.default.writeFile(htmlFilepath.replace(/\\.html$/, \".prefetch.rsc\"), prefetchRscData);\n}\nasync function exportAppPage(req, res, page, path, pathname, query, renderOpts, htmlFilepath, debugOutput, isDynamicError, isAppPrefetch) {\n  // If the page is `/_not-found`, then we should update the page to be `/404`.\n  if (page === \"/_not-found\") {\n    pathname = \"/404\";\n  }\n  try {\n    if (isAppPrefetch) {\n      await generatePrefetchRsc(req, path, res, pathname, query, htmlFilepath, renderOpts);\n      return {\n        fromBuildExportRevalidate: 0\n      };\n    }\n    const result = await render(req, res, pathname, query, renderOpts);\n    const html = result.toUnchunkedString();\n    const {\n      metadata\n    } = result;\n    const flightData = metadata.pageData;\n    const revalidate = metadata.revalidate;\n    if (revalidate === 0) {\n      if (isDynamicError) {\n        throw new Error(`Page with dynamic = \"error\" encountered dynamic data method on ${path}.`);\n      }\n      await generatePrefetchRsc(req, path, res, pathname, query, htmlFilepath, renderOpts);\n      const {\n        staticBailoutInfo = {}\n      } = metadata;\n      if (revalidate === 0 && debugOutput && (staticBailoutInfo == null ? void 0 : staticBailoutInfo.description)) {\n        const err = new Error(`Static generation failed due to dynamic usage on ${path}, reason: ${staticBailoutInfo.description}`);\n        // Update the stack if it was provided via the bailout info.\n        const {\n          stack\n        } = staticBailoutInfo;\n        if (stack) {\n          err.stack = err.message + stack.substring(stack.indexOf(\"\\n\"));\n        }\n        console.warn(err);\n      }\n      return {\n        fromBuildExportRevalidate: 0\n      };\n    }\n    let headers;\n    if (metadata.fetchTags) {\n      headers = {\n        [_constants.NEXT_CACHE_TAGS_HEADER]: metadata.fetchTags\n      };\n    }\n    // Writing static HTML to a file.\n    await _promises.default.writeFile(htmlFilepath, html ?? \"\", \"utf8\");\n    // Writing the request metadata to a file.\n    const meta = {\n      headers\n    };\n    await _promises.default.writeFile(htmlFilepath.replace(/\\.html$/, \".meta\"), JSON.stringify(meta));\n    // Writing the RSC payload to a file.\n    await _promises.default.writeFile(htmlFilepath.replace(/\\.html$/, \".rsc\"), flightData);\n    return {\n      fromBuildExportRevalidate: revalidate,\n      // Only include the metadata if the environment has next support.\n      fromBuildExportMeta: _ciinfo.hasNextSupport ? meta : undefined\n    };\n  } catch (err) {\n    if (!(0, _isdynamicusageerror.isDynamicUsageError)(err)) {\n      throw err;\n    }\n    return {\n      fromBuildExportRevalidate: 0\n    };\n  }\n}","map":{"version":3,"names":["generatePrefetchRsc","exportAppPage","render","args","require","renderToHTMLOrFlight","req","path","res","pathname","query","htmlFilepath","renderOpts","headers","_approuterheaders","RSC","toLowerCase","NEXT_URL","NEXT_ROUTER_PREFETCH","supportsDynamicHTML","isRevalidate","prefetchRenderResult","pipe","hasStreamed","prefetchRscData","Buffer","concat","buffers","_promises","default","writeFile","replace","page","debugOutput","isDynamicError","isAppPrefetch","fromBuildExportRevalidate","result","html","toUnchunkedString","metadata","flightData","pageData","revalidate","Error","staticBailoutInfo","description","err","stack","message","substring","indexOf","console","warn","fetchTags","_constants","NEXT_CACHE_TAGS_HEADER","meta","JSON","stringify","fromBuildExportMeta","_ciinfo","hasNextSupport","undefined","_isdynamicusageerror","isDynamicUsageError"],"sources":["../../../src/export/routes/app-page.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}
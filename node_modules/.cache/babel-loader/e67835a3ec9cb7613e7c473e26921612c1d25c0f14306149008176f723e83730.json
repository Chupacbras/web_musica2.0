{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n0 && (module.exports = {\n  deleteAppClientCache: null,\n  deleteCache: null,\n  NextJsRequireCacheHotReloader: null\n});\nfunction _export(target, all) {\n  for (var name in all) Object.defineProperty(target, name, {\n    enumerable: true,\n    get: all[name]\n  });\n}\n_export(exports, {\n  deleteAppClientCache: function () {\n    return deleteAppClientCache;\n  },\n  deleteCache: function () {\n    return deleteCache;\n  },\n  NextJsRequireCacheHotReloader: function () {\n    return NextJsRequireCacheHotReloader;\n  }\n});\nconst _sandbox = require(\"../../../server/web/sandbox\");\nconst _realpath = require(\"../../../lib/realpath\");\nconst _path = /*#__PURE__*/_interop_require_default(require(\"path\"));\nconst _iserror = /*#__PURE__*/_interop_require_default(require(\"../../../lib/is-error\"));\nconst _loadmanifest = require(\"../../../server/load-manifest\");\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nconst originModules = [require.resolve(\"../../../server/require\"), require.resolve(\"../../../server/load-components\"), require.resolve(\"../../../server/next-server\"), require.resolve(\"next/dist/compiled/next-server/app-page.runtime.dev.js\"), require.resolve(\"next/dist/compiled/next-server/app-route.runtime.dev.js\"), require.resolve(\"next/dist/compiled/next-server/pages.runtime.dev.js\"), require.resolve(\"next/dist/compiled/next-server/pages-api.runtime.dev.js\")];\nconst RUNTIME_NAMES = [\"webpack-runtime\", \"webpack-api-runtime\"];\nfunction deleteFromRequireCache(filePath) {\n  try {\n    filePath = (0, _realpath.realpathSync)(filePath);\n  } catch (e) {\n    if ((0, _iserror.default)(e) && e.code !== \"ENOENT\") throw e;\n  }\n  const mod = require.cache[filePath];\n  if (mod) {\n    // remove the child reference from the originModules\n    for (const originModule of originModules) {\n      const parent = require.cache[originModule];\n      if (parent) {\n        const idx = parent.children.indexOf(mod);\n        if (idx >= 0) parent.children.splice(idx, 1);\n      }\n    }\n    // remove parent references from external modules\n    for (const child of mod.children) {\n      child.parent = null;\n    }\n    delete require.cache[filePath];\n    return true;\n  }\n  return false;\n}\nfunction deleteAppClientCache() {\n  deleteFromRequireCache(require.resolve(\"next/dist/compiled/next-server/app-page.runtime.dev.js\"));\n}\nfunction deleteCache(filePath) {\n  // try to clear it from the fs cache\n  (0, _loadmanifest.clearManifestCache)(filePath);\n  deleteFromRequireCache(filePath);\n}\nconst PLUGIN_NAME = \"NextJsRequireCacheHotReloader\";\nclass NextJsRequireCacheHotReloader {\n  constructor(opts) {\n    this.prevAssets = null;\n    this.hasServerComponents = opts.hasServerComponents;\n  }\n  apply(compiler) {\n    compiler.hooks.assetEmitted.tap(PLUGIN_NAME, (_file, {\n      targetPath\n    }) => {\n      // Clear module context in this process\n      (0, _sandbox.clearModuleContext)(targetPath);\n      deleteCache(targetPath);\n    });\n    compiler.hooks.afterEmit.tapPromise(PLUGIN_NAME, async compilation => {\n      for (const name of RUNTIME_NAMES) {\n        const runtimeChunkPath = _path.default.join(compilation.outputOptions.path, `${name}.js`);\n        deleteCache(runtimeChunkPath);\n      }\n      // we need to make sure to clear all server entries from cache\n      // since they can have a stale webpack-runtime cache\n      // which needs to always be in-sync\n      let hasAppEntry = false;\n      const entries = [...compilation.entries.keys()].filter(entry => {\n        const isAppPath = entry.toString().startsWith(\"app/\");\n        if (isAppPath) hasAppEntry = true;\n        return entry.toString().startsWith(\"pages/\") || isAppPath;\n      });\n      if (hasAppEntry) {\n        deleteAppClientCache();\n      }\n      for (const page of entries) {\n        const outputPath = _path.default.join(compilation.outputOptions.path, page + \".js\");\n        deleteCache(outputPath);\n      }\n    });\n  }\n}","map":{"version":3,"names":["deleteAppClientCache","deleteCache","NextJsRequireCacheHotReloader","originModules","require","resolve","RUNTIME_NAMES","deleteFromRequireCache","filePath","_realpath","realpathSync","e","_iserror","default","code","mod","cache","originModule","parent","idx","children","indexOf","splice","child","_loadmanifest","clearManifestCache","PLUGIN_NAME","constructor","opts","prevAssets","hasServerComponents","apply","compiler","hooks","assetEmitted","tap","_file","targetPath","_sandbox","clearModuleContext","afterEmit","tapPromise","compilation","name","runtimeChunkPath","_path","join","outputOptions","path","hasAppEntry","entries","keys","filter","entry","isAppPath","toString","startsWith","page","outputPath"],"sources":["../../../../src/build/webpack/plugins/nextjs-require-cache-hot-reloader.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}
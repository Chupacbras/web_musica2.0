{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"FontStylesheetGatheringPlugin\", {\n  enumerable: true,\n  get: function () {\n    return FontStylesheetGatheringPlugin;\n  }\n});\nconst _webpack = require(\"next/dist/compiled/webpack/webpack\");\nconst _fontutils = require(\"../../../server/font-utils\");\nconst _postcss = /*#__PURE__*/_interop_require_default(require(\"postcss\"));\nconst _cssnanosimple = /*#__PURE__*/_interop_require_default(require(\"next/dist/compiled/cssnano-simple\"));\nconst _constants = require(\"../../../shared/lib/constants\");\nconst _log = /*#__PURE__*/_interop_require_wildcard(require(\"../../output/log\"));\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function (nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\nfunction _interop_require_wildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      default: obj\n    };\n  }\n  var cache = _getRequireWildcardCache(nodeInterop);\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n  newObj.default = obj;\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n  return newObj;\n}\nfunction minifyCss(css) {\n  return (0, _postcss.default)([(0, _cssnanosimple.default)({\n    excludeAll: true,\n    discardComments: true,\n    normalizeWhitespace: {\n      exclude: false\n    }\n  }, _postcss.default)]).process(css, {\n    from: undefined\n  }).then(res => res.css);\n}\nfunction isNodeCreatingLinkElement(node) {\n  const callee = node.callee;\n  if (callee.type !== \"Identifier\") {\n    return false;\n  }\n  const componentNode = node.arguments[0];\n  if (componentNode.type !== \"Literal\") {\n    return false;\n  }\n  // React has pragma: _jsx.\n  // Next has pragma: __jsx.\n  return (callee.name === \"_jsx\" || callee.name === \"__jsx\") && componentNode.value === \"link\";\n}\nclass FontStylesheetGatheringPlugin {\n  constructor({\n    adjustFontFallbacks,\n    adjustFontFallbacksWithSizeAdjust\n  }) {\n    this.gatheredStylesheets = [];\n    this.manifestContent = [];\n    this.parserHandler = factory => {\n      const JS_TYPES = [\"auto\", \"esm\", \"dynamic\"];\n      // Do an extra walk per module and add interested visitors to the walk.\n      for (const type of JS_TYPES) {\n        factory.hooks.parser.for(\"javascript/\" + type).tap(this.constructor.name, parser => {\n          /**\n          * Webpack fun facts:\n          * `parser.hooks.call.for` cannot catch calls for user defined identifiers like `__jsx`\n          * it can only detect calls for native objects like `window`, `this`, `eval` etc.\n          * In order to be able to catch calls of variables like `__jsx`, first we need to catch them as\n          * Identifier and then return `BasicEvaluatedExpression` whose `id` and `type` webpack matches to\n          * invoke hook for call.\n          * See: https://github.com/webpack/webpack/blob/webpack-4/lib/Parser.js#L1931-L1932.\n          */\n          parser.hooks.evaluate.for(\"Identifier\").tap(this.constructor.name, node => {\n            var _parser_state_module, _parser_state;\n            // We will only optimize fonts from first party code.\n            if (parser == null ? void 0 : (_parser_state = parser.state) == null ? void 0 : (_parser_state_module = _parser_state.module) == null ? void 0 : _parser_state_module.resource.includes(\"node_modules\")) {\n              return;\n            }\n            let result;\n            if (node.name === \"_jsx\" || node.name === \"__jsx\") {\n              result = new _webpack.BasicEvaluatedExpression();\n              // @ts-ignore\n              result.setRange(node.range);\n              result.setExpression(node);\n              result.setIdentifier(node.name);\n              // This was added in webpack 5.\n              result.getMembers = () => [];\n            }\n            return result;\n          });\n          const jsxNodeHandler = node => {\n            var _parser_state_module, _parser_state;\n            if (node.arguments.length !== 2) {\n              // A font link tag has only two arguments rel=stylesheet and href='...'\n              return;\n            }\n            if (!isNodeCreatingLinkElement(node)) {\n              return;\n            }\n            // node.arguments[0] is the name of the tag and [1] are the props.\n            const arg1 = node.arguments[1];\n            const propsNode = arg1.type === \"ObjectExpression\" ? arg1 : undefined;\n            const props = {};\n            if (propsNode) {\n              propsNode.properties.forEach(prop => {\n                if (prop.type !== \"Property\") {\n                  return;\n                }\n                if (prop.key.type === \"Identifier\" && prop.value.type === \"Literal\") {\n                  props[prop.key.name] = prop.value.value;\n                }\n              });\n            }\n            if (!props.rel || props.rel !== \"stylesheet\" || !props.href || !_constants.OPTIMIZED_FONT_PROVIDERS.some(({\n              url\n            }) => props.href.startsWith(url))) {\n              return false;\n            }\n            this.gatheredStylesheets.push(props.href);\n            const buildInfo = parser == null ? void 0 : (_parser_state = parser.state) == null ? void 0 : (_parser_state_module = _parser_state.module) == null ? void 0 : _parser_state_module.buildInfo;\n            if (buildInfo) {\n              buildInfo.valueDependencies.set(_constants.FONT_MANIFEST, this.gatheredStylesheets);\n            }\n          };\n          // React JSX transform:\n          parser.hooks.call.for(\"_jsx\").tap(this.constructor.name, jsxNodeHandler);\n          // Next.js JSX transform:\n          parser.hooks.call.for(\"__jsx\").tap(this.constructor.name, jsxNodeHandler);\n          // New React JSX transform:\n          parser.hooks.call.for(\"imported var\").tap(this.constructor.name, jsxNodeHandler);\n        });\n      }\n    };\n    this.adjustFontFallbacks = adjustFontFallbacks;\n    this.adjustFontFallbacksWithSizeAdjust = adjustFontFallbacksWithSizeAdjust;\n  }\n  apply(compiler) {\n    this.compiler = compiler;\n    compiler.hooks.normalModuleFactory.tap(this.constructor.name, this.parserHandler);\n    compiler.hooks.make.tapAsync(this.constructor.name, (compilation, cb) => {\n      compilation.hooks.finishModules.tapAsync(this.constructor.name, async (modules, modulesFinished) => {\n        let fontStylesheets = this.gatheredStylesheets;\n        const fontUrls = new Set();\n        modules.forEach(module => {\n          var _module_buildInfo_valueDependencies, _module_buildInfo;\n          const fontDependencies = module == null ? void 0 : (_module_buildInfo = module.buildInfo) == null ? void 0 : (_module_buildInfo_valueDependencies = _module_buildInfo.valueDependencies) == null ? void 0 : _module_buildInfo_valueDependencies.get(_constants.FONT_MANIFEST);\n          if (fontDependencies) {\n            fontDependencies.forEach(v => fontUrls.add(v));\n          }\n        });\n        fontStylesheets = Array.from(fontUrls);\n        const fontDefinitionPromises = fontStylesheets.map(url => (0, _fontutils.getFontDefinitionFromNetwork)(url));\n        this.manifestContent = [];\n        for (let promiseIndex in fontDefinitionPromises) {\n          let css = await fontDefinitionPromises[promiseIndex];\n          if (this.adjustFontFallbacks) {\n            css += (0, _fontutils.getFontOverrideCss)(fontStylesheets[promiseIndex], css, this.adjustFontFallbacksWithSizeAdjust);\n          }\n          if (css) {\n            try {\n              const content = await minifyCss(css);\n              this.manifestContent.push({\n                url: fontStylesheets[promiseIndex],\n                content\n              });\n            } catch (err) {\n              _log.warn(`Failed to minify the stylesheet for ${fontStylesheets[promiseIndex]}. Skipped optimizing this font.`);\n              console.error(err);\n            }\n          }\n        }\n        // @ts-expect-error invalid assets type\n        compilation.assets[_constants.FONT_MANIFEST] = new _webpack.sources.RawSource(JSON.stringify(this.manifestContent, null, \"  \"));\n        modulesFinished();\n      });\n      cb();\n    });\n    compiler.hooks.make.tap(this.constructor.name, compilation => {\n      compilation.hooks.processAssets.tap({\n        name: this.constructor.name,\n        stage: _webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS\n      }, assets => {\n        assets[\"../\" + _constants.FONT_MANIFEST] = new _webpack.sources.RawSource(JSON.stringify(this.manifestContent, null, \"  \"));\n      });\n    });\n  }\n}","map":{"version":3,"names":["FontStylesheetGatheringPlugin","minifyCss","css","_postcss","default","_cssnanosimple","excludeAll","discardComments","normalizeWhitespace","exclude","process","from","undefined","then","res","isNodeCreatingLinkElement","node","callee","type","componentNode","arguments","name","value","constructor","adjustFontFallbacks","adjustFontFallbacksWithSizeAdjust","gatheredStylesheets","manifestContent","parserHandler","factory","JS_TYPES","hooks","parser","for","tap","evaluate","_parser_state_module","_parser_state","state","module","resource","includes","result","_webpack","BasicEvaluatedExpression","setRange","range","setExpression","setIdentifier","getMembers","jsxNodeHandler","length","arg1","propsNode","props","properties","forEach","prop","key","rel","href","_constants","OPTIMIZED_FONT_PROVIDERS","some","url","startsWith","push","buildInfo","valueDependencies","set","FONT_MANIFEST","call","apply","compiler","normalModuleFactory","make","tapAsync","compilation","cb","finishModules","modules","modulesFinished","fontStylesheets","fontUrls","Set","_module_buildInfo_valueDependencies","_module_buildInfo","fontDependencies","get","v","add","Array","fontDefinitionPromises","map","_fontutils","getFontDefinitionFromNetwork","promiseIndex","getFontOverrideCss","content","err","_log","warn","console","error","assets","sources","RawSource","JSON","stringify","processAssets","stage","webpack","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS"],"sources":["../../../../src/build/webpack/plugins/font-stylesheet-gathering-plugin.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}
{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"webpackBuild\", {\n  enumerable: true,\n  get: function () {\n    return webpackBuild;\n  }\n});\nconst _log = /*#__PURE__*/_interop_require_wildcard(require(\"../output/log\"));\nconst _buildcontext = require(\"../build-context\");\nconst _jestworker = require(\"next/dist/compiled/jest-worker\");\nconst _debug = /*#__PURE__*/_interop_require_default(require(\"next/dist/compiled/debug\"));\nconst _path = /*#__PURE__*/_interop_require_default(require(\"path\"));\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function (nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\nfunction _interop_require_wildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      default: obj\n    };\n  }\n  var cache = _getRequireWildcardCache(nodeInterop);\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n  newObj.default = obj;\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n  return newObj;\n}\nconst debug = (0, _debug.default)(\"next:build:webpack-build\");\nasync function webpackBuildWithWorker() {\n  const {\n    config,\n    telemetryPlugin,\n    buildSpinner,\n    nextBuildSpan,\n    ...prunedBuildContext\n  } = _buildcontext.NextBuildContext;\n  const getWorker = compilerName => {\n    var _worker__workerPool;\n    const _worker = new _jestworker.Worker(_path.default.join(__dirname, \"impl.js\"), {\n      exposedMethods: [\"workerMain\"],\n      numWorkers: 1,\n      maxRetries: 0,\n      forkOptions: {\n        env: {\n          ...process.env,\n          NEXT_PRIVATE_BUILD_WORKER: \"1\"\n        }\n      }\n    });\n    _worker.getStderr().pipe(process.stderr);\n    _worker.getStdout().pipe(process.stdout);\n    for (const worker of ((_worker__workerPool = _worker._workerPool) == null ? void 0 : _worker__workerPool._workers) || []) {\n      worker._child.on(\"exit\", (code, signal) => {\n        if (code || signal) {\n          console.error(`Compiler ${compilerName} unexpectedly exited with code: ${code} and signal: ${signal}`);\n        }\n      });\n    }\n    return _worker;\n  };\n  const combinedResult = {\n    duration: 0,\n    turbotraceContext: {}\n  };\n  // order matters here\n  const ORDERED_COMPILER_NAMES = [\"server\", \"edge-server\", \"client\"];\n  for (const compilerName of ORDERED_COMPILER_NAMES) {\n    var _curResult_serializedPagesManifestEntries, _curResult_serializedPagesManifestEntries1, _curResult_serializedPagesManifestEntries2, _curResult_serializedPagesManifestEntries3, _curResult_turbotraceContext;\n    const worker = getWorker(compilerName);\n    const curResult = await worker.workerMain({\n      buildContext: prunedBuildContext,\n      compilerName\n    });\n    // destroy worker so it's not sticking around using memory\n    await worker.end();\n    // Update plugin state\n    prunedBuildContext.pluginState = curResult.pluginState;\n    prunedBuildContext.serializedPagesManifestEntries = {\n      edgeServerAppPaths: (_curResult_serializedPagesManifestEntries = curResult.serializedPagesManifestEntries) == null ? void 0 : _curResult_serializedPagesManifestEntries.edgeServerAppPaths,\n      edgeServerPages: (_curResult_serializedPagesManifestEntries1 = curResult.serializedPagesManifestEntries) == null ? void 0 : _curResult_serializedPagesManifestEntries1.edgeServerPages,\n      nodeServerAppPaths: (_curResult_serializedPagesManifestEntries2 = curResult.serializedPagesManifestEntries) == null ? void 0 : _curResult_serializedPagesManifestEntries2.nodeServerAppPaths,\n      nodeServerPages: (_curResult_serializedPagesManifestEntries3 = curResult.serializedPagesManifestEntries) == null ? void 0 : _curResult_serializedPagesManifestEntries3.nodeServerPages\n    };\n    combinedResult.duration += curResult.duration;\n    if ((_curResult_turbotraceContext = curResult.turbotraceContext) == null ? void 0 : _curResult_turbotraceContext.entriesTrace) {\n      combinedResult.turbotraceContext = curResult.turbotraceContext;\n      const {\n        entryNameMap\n      } = combinedResult.turbotraceContext.entriesTrace;\n      if (entryNameMap) {\n        combinedResult.turbotraceContext.entriesTrace.entryNameMap = new Map(entryNameMap);\n      }\n    }\n  }\n  buildSpinner == null ? void 0 : buildSpinner.stopAndPersist();\n  _log.event(\"Compiled successfully\");\n  return combinedResult;\n}\nasync function webpackBuild() {\n  const config = _buildcontext.NextBuildContext.config;\n  if (config.experimental.webpackBuildWorker) {\n    debug(\"using separate compiler workers\");\n    return await webpackBuildWithWorker();\n  } else {\n    debug(\"building all compilers in same process\");\n    const webpackBuildImpl = require(\"./impl\").webpackBuildImpl;\n    return await webpackBuildImpl();\n  }\n}","map":{"version":3,"names":["webpackBuild","debug","_debug","default","webpackBuildWithWorker","config","telemetryPlugin","buildSpinner","nextBuildSpan","prunedBuildContext","_buildcontext","NextBuildContext","getWorker","compilerName","_worker__workerPool","_worker","_jestworker","Worker","_path","join","__dirname","exposedMethods","numWorkers","maxRetries","forkOptions","env","process","NEXT_PRIVATE_BUILD_WORKER","getStderr","pipe","stderr","getStdout","stdout","worker","_workerPool","_workers","_child","on","code","signal","console","error","combinedResult","duration","turbotraceContext","ORDERED_COMPILER_NAMES","_curResult_serializedPagesManifestEntries","_curResult_serializedPagesManifestEntries1","_curResult_serializedPagesManifestEntries2","_curResult_serializedPagesManifestEntries3","_curResult_turbotraceContext","curResult","workerMain","buildContext","end","pluginState","serializedPagesManifestEntries","edgeServerAppPaths","edgeServerPages","nodeServerAppPaths","nodeServerPages","entriesTrace","entryNameMap","Map","stopAndPersist","_log","event","experimental","webpackBuildWorker","webpackBuildImpl","require"],"sources":["../../../src/build/webpack-build/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}
{"ast":null,"code":"// Based on https://github.com/webpack-contrib/webpack-hot-middleware/blob/9708d781ae0e46179cf8ea1a94719de4679aaf53/middleware.js\n// Included License below\n// Copyright JS Foundation and other contributors\n// Permission is hereby granted, free of charge, to any person obtaining\n// a copy of this software and associated documentation files (the\n// 'Software'), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to\n// permit persons to whom the Software is furnished to do so, subject to\n// the following conditions:\n// The above copyright notice and this permission notice shall be\n// included in all copies or substantial portions of the Software.\n// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n// CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n// TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n// SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"WebpackHotMiddleware\", {\n  enumerable: true,\n  get: function () {\n    return WebpackHotMiddleware;\n  }\n});\nconst _utils = require(\"../../build/utils\");\nconst _hotreloadertypes = require(\"./hot-reloader-types\");\nfunction isMiddlewareStats(stats) {\n  for (const key of stats.compilation.entrypoints.keys()) {\n    if ((0, _utils.isMiddlewareFilename)(key)) {\n      return true;\n    }\n  }\n  return false;\n}\nfunction statsToJson(stats) {\n  if (!stats) return {};\n  return stats.toJson({\n    all: false,\n    errors: true,\n    hash: true,\n    warnings: true\n  });\n}\nfunction getStatsForSyncEvent(clientStats, serverStats) {\n  if (!clientStats) return serverStats == null ? void 0 : serverStats.stats;\n  if (!serverStats) return clientStats == null ? void 0 : clientStats.stats;\n  // Prefer the server compiler stats if it has errors.\n  // Otherwise we may end up in a state where the client compilation is the latest but without errors.\n  // This causes the error overlay to not display the build error.\n  if (serverStats.stats.hasErrors()) {\n    return serverStats.stats;\n  }\n  // Return the latest stats\n  return serverStats.ts > clientStats.ts ? serverStats.stats : clientStats.stats;\n}\nclass EventStream {\n  constructor() {\n    this.clients = new Set();\n  }\n  everyClient(fn) {\n    for (const client of this.clients) {\n      fn(client);\n    }\n  }\n  close() {\n    this.everyClient(client => {\n      client.close();\n    });\n    this.clients.clear();\n  }\n  handler(client) {\n    this.clients.add(client);\n    client.addEventListener(\"close\", () => {\n      this.clients.delete(client);\n    });\n  }\n  publish(payload) {\n    this.everyClient(client => {\n      client.send(JSON.stringify(payload));\n    });\n  }\n}\nclass WebpackHotMiddleware {\n  constructor(compilers, versionInfo) {\n    this.onClientInvalid = () => {\n      var _this_serverLatestStats;\n      if (this.closed || ((_this_serverLatestStats = this.serverLatestStats) == null ? void 0 : _this_serverLatestStats.stats.hasErrors())) return;\n      this.publish({\n        action: _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILDING\n      });\n    };\n    this.onClientDone = statsResult => {\n      var _this_serverLatestStats;\n      this.clientLatestStats = {\n        ts: Date.now(),\n        stats: statsResult\n      };\n      if (this.closed || ((_this_serverLatestStats = this.serverLatestStats) == null ? void 0 : _this_serverLatestStats.stats.hasErrors())) return;\n      this.publishStats(statsResult);\n    };\n    this.onServerInvalid = () => {\n      var _this_serverLatestStats, _this_clientLatestStats;\n      if (!((_this_serverLatestStats = this.serverLatestStats) == null ? void 0 : _this_serverLatestStats.stats.hasErrors())) return;\n      this.serverLatestStats = null;\n      if ((_this_clientLatestStats = this.clientLatestStats) == null ? void 0 : _this_clientLatestStats.stats) {\n        this.publishStats(this.clientLatestStats.stats);\n      }\n    };\n    this.onServerDone = statsResult => {\n      if (this.closed) return;\n      if (statsResult.hasErrors()) {\n        this.serverLatestStats = {\n          ts: Date.now(),\n          stats: statsResult\n        };\n        this.publishStats(statsResult);\n      }\n    };\n    this.onEdgeServerInvalid = () => {\n      var _this_middlewareLatestStats, _this_clientLatestStats;\n      if (!((_this_middlewareLatestStats = this.middlewareLatestStats) == null ? void 0 : _this_middlewareLatestStats.stats.hasErrors())) return;\n      this.middlewareLatestStats = null;\n      if ((_this_clientLatestStats = this.clientLatestStats) == null ? void 0 : _this_clientLatestStats.stats) {\n        this.publishStats(this.clientLatestStats.stats);\n      }\n    };\n    this.onEdgeServerDone = statsResult => {\n      if (!isMiddlewareStats(statsResult)) {\n        this.onServerDone(statsResult);\n        return;\n      }\n      if (statsResult.hasErrors()) {\n        this.middlewareLatestStats = {\n          ts: Date.now(),\n          stats: statsResult\n        };\n        this.publishStats(statsResult);\n      }\n    };\n    /**\n    * To sync we use the most recent stats but also we append middleware\n    * errors. This is because it is possible that middleware fails to compile\n    * and we still want to show the client overlay with the error while\n    * the error page should be rendered just fine.\n    */\n    this.onHMR = client => {\n      if (this.closed) return;\n      this.eventStream.handler(client);\n      const syncStats = getStatsForSyncEvent(this.clientLatestStats, this.serverLatestStats);\n      if (syncStats) {\n        var _this_middlewareLatestStats;\n        const stats = statsToJson(syncStats);\n        const middlewareStats = statsToJson((_this_middlewareLatestStats = this.middlewareLatestStats) == null ? void 0 : _this_middlewareLatestStats.stats);\n        this.publish({\n          action: _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SYNC,\n          hash: stats.hash,\n          errors: [...(stats.errors || []), ...(middlewareStats.errors || [])],\n          warnings: [...(stats.warnings || []), ...(middlewareStats.warnings || [])],\n          versionInfo: this.versionInfo\n        });\n      }\n    };\n    this.publishStats = statsResult => {\n      const stats = statsResult.toJson({\n        all: false,\n        hash: true,\n        warnings: true,\n        errors: true,\n        moduleTrace: true\n      });\n      this.publish({\n        action: _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILT,\n        hash: stats.hash,\n        warnings: stats.warnings || [],\n        errors: stats.errors || []\n      });\n    };\n    this.publish = payload => {\n      if (this.closed) return;\n      this.eventStream.publish(payload);\n    };\n    this.close = () => {\n      if (this.closed) return;\n      // Can't remove compiler plugins, so we just set a flag and noop if closed\n      // https://github.com/webpack/tapable/issues/32#issuecomment-350644466\n      this.closed = true;\n      this.eventStream.close();\n    };\n    this.eventStream = new EventStream();\n    this.clientLatestStats = null;\n    this.middlewareLatestStats = null;\n    this.serverLatestStats = null;\n    this.closed = false;\n    this.versionInfo = versionInfo;\n    compilers[0].hooks.invalid.tap(\"webpack-hot-middleware\", this.onClientInvalid);\n    compilers[0].hooks.done.tap(\"webpack-hot-middleware\", this.onClientDone);\n    compilers[1].hooks.invalid.tap(\"webpack-hot-middleware\", this.onServerInvalid);\n    compilers[1].hooks.done.tap(\"webpack-hot-middleware\", this.onServerDone);\n    compilers[2].hooks.done.tap(\"webpack-hot-middleware\", this.onEdgeServerDone);\n    compilers[2].hooks.invalid.tap(\"webpack-hot-middleware\", this.onEdgeServerInvalid);\n  }\n}","map":{"version":3,"names":["WebpackHotMiddleware","isMiddlewareStats","stats","key","compilation","entrypoints","keys","_utils","isMiddlewareFilename","statsToJson","toJson","all","errors","hash","warnings","getStatsForSyncEvent","clientStats","serverStats","hasErrors","ts","EventStream","constructor","clients","Set","everyClient","fn","client","close","clear","handler","add","addEventListener","delete","publish","payload","send","JSON","stringify","compilers","versionInfo","onClientInvalid","_this_serverLatestStats","closed","serverLatestStats","action","_hotreloadertypes","HMR_ACTIONS_SENT_TO_BROWSER","BUILDING","onClientDone","statsResult","clientLatestStats","Date","now","publishStats","onServerInvalid","_this_clientLatestStats","onServerDone","onEdgeServerInvalid","_this_middlewareLatestStats","middlewareLatestStats","onEdgeServerDone","onHMR","eventStream","syncStats","middlewareStats","SYNC","moduleTrace","BUILT","hooks","invalid","tap","done"],"sources":["../../../src/server/dev/hot-middleware.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}